{% extends "hr/dashboard.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h4 mb-1">Invoice Management</h1>
    <p class="text-muted small mb-0">Manage client billing</p>
  </div>
  <a href="#invoiceFormCard" class="btn btn-primary btn-sm">Create Invoice</a>
</div>

<div class="row g-3 mb-3">
  <div class="col-12 col-md-6 col-xl-2">
    <div class="card border-0 shadow-sm h-100"><div class="card-body"><div class="small text-muted">Total Invoices</div><div class="fs-5 fw-semibold">{{ total_invoices }}</div></div></div>
  </div>
  <div class="col-12 col-md-6 col-xl-2">
    <div class="card border-0 shadow-sm h-100"><div class="card-body"><div class="small text-muted">Total Revenue</div><div class="fs-5 fw-semibold">{{ total_revenue }}</div></div></div>
  </div>
  <div class="col-12 col-md-6 col-xl-2">
    <div class="card border-0 shadow-sm h-100"><div class="card-body"><div class="small text-muted">Paid Amount</div><div class="fs-5 fw-semibold text-success">{{ paid_total }}</div></div></div>
  </div>
  <div class="col-12 col-md-6 col-xl-2">
    <div class="card border-0 shadow-sm h-100"><div class="card-body"><div class="small text-muted">Pending Amount</div><div class="fs-5 fw-semibold text-warning">{{ pending_total }}</div></div></div>
  </div>
  <div class="col-12 col-md-6 col-xl-2">
    <div class="card border-0 shadow-sm h-100"><div class="card-body"><div class="small text-muted">Overdue Count</div><div class="fs-5 fw-semibold text-danger">{{ overdue_count }}</div></div></div>
  </div>
</div>

<div class="card border-0 shadow-sm mb-3" id="invoiceFormCard">
  <div class="card-header">
    <h2 class="h6 mb-0">{% if editing %}Edit Invoice{% else %}Create Invoice{% endif %}</h2>
  </div>
  <div class="card-body">
    <form method="post" action="{% if editing %}{% url 'hr:invoice_update' edit_invoice.pk %}{% else %}{% url 'hr:invoice_create' %}{% endif %}">
      {% csrf_token %}
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label small fw-semibold mb-1">Client</label>
          {{ form.client }}
        </div>
        <div class="col-md-6">
          <label class="form-label small fw-semibold mb-1">Project</label>
          {{ form.project }}
        </div>
        <div class="col-md-3">
          <label class="form-label small fw-semibold mb-1">Amount</label>
          {{ form.amount }}
        </div>
        <div class="col-md-3">
          <label class="form-label small fw-semibold mb-1">Tax %</label>
          {{ form.tax_percentage }}
        </div>
        <div class="col-md-3">
          <label class="form-label small fw-semibold mb-1">Due Date</label>
          {{ form.due_date }}
        </div>
        <div class="col-md-3">
          <label class="form-label small fw-semibold mb-1">Status</label>
          {{ form.status }}
        </div>
      </div>
      <div class="mt-3 d-flex gap-2">
        <button type="submit" class="btn btn-primary btn-sm">{% if editing %}Update Invoice{% else %}Save Invoice{% endif %}</button>
        {% if editing %}
          <a class="btn btn-outline-secondary btn-sm" href="{% url 'hr:invoice_list' %}">Cancel</a>
        {% endif %}
      </div>
    </form>
  </div>
</div>

<div class="card border-0 shadow-sm">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h2 class="h6 mb-0">Invoice Records</h2>
    <span class="badge bg-secondary-subtle text-secondary">{{ invoices|length }} record{{ invoices|length|pluralize }}</span>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th>Invoice Number</th>
            <th>Client</th>
            <th>Project</th>
            <th>Amount</th>
            <th>Tax %</th>
            <th>Total Amount</th>
            <th>Due Date</th>
            <th>Status</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody class="small">
          {% for invoice in invoices %}
            <tr>
              <td>{{ invoice.invoice_number }}</td>
              <td>{{ invoice.client.company_name }}</td>
              <td>{{ invoice.project.name }}</td>
              <td>{{ invoice.amount }}</td>
              <td>{{ invoice.tax_percentage }}</td>
              <td class="fw-semibold">{{ invoice.total_amount }}</td>
              <td>{{ invoice.due_date }}</td>
              <td>
                {% if invoice.status == "PAID" %}
                  <span class="badge bg-success-subtle text-success">Paid</span>
                {% elif invoice.status == "PARTIAL" %}
                  <span class="badge bg-info-subtle text-info">Partial</span>
                {% else %}
                  <span class="badge bg-warning-subtle text-warning">Unpaid</span>
                {% endif %}
              </td>
              <td class="text-end">
                <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#viewInvoiceModal{{ invoice.pk }}">View</button>
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'hr:invoice_update' invoice.pk %}">Edit</a>
                <form method="post" action="{% url 'hr:invoice_delete' invoice.pk %}" class="d-inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                </form>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="9" class="text-center py-4 text-muted">No invoice records found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% for invoice in invoices %}
<div class="modal fade" id="viewInvoiceModal{{ invoice.pk }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Invoice Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body small">
        <div class="row g-3">
          <div class="col-md-6"><div class="text-muted">Invoice Number</div><div class="fw-semibold">{{ invoice.invoice_number }}</div></div>
          <div class="col-md-6"><div class="text-muted">Status</div><div class="fw-semibold">{{ invoice.get_status_display }}</div></div>
          <div class="col-md-6"><div class="text-muted">Client</div><div>{{ invoice.client.company_name }}</div></div>
          <div class="col-md-6"><div class="text-muted">Project</div><div>{{ invoice.project.name }}</div></div>
          <div class="col-md-4"><div class="text-muted">Amount</div><div>{{ invoice.amount }}</div></div>
          <div class="col-md-4"><div class="text-muted">Tax %</div><div>{{ invoice.tax_percentage }}</div></div>
          <div class="col-md-4"><div class="text-muted">Tax Amount</div><div>{{ invoice.tax_amount }}</div></div>
          <div class="col-md-6"><div class="text-muted">Total Amount</div><div class="fw-semibold">{{ invoice.total_amount }}</div></div>
          <div class="col-md-6"><div class="text-muted">Due Date</div><div>{{ invoice.due_date|date:"d M Y" }}</div></div>
          <div class="col-md-6"><div class="text-muted">Created At</div><div>{{ invoice.created_at|date:"d M Y, h:i A" }}</div></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endfor %}
{% endblock %}
