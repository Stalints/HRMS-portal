{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Support | HR Portal</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />

  <link rel="stylesheet" href="{% static 'core/css/style.css' %}">

  <style>
    :root{
      /* match your dashboard/projects palette */
      --bg: #f6f7fb;
      --card: rgba(255,255,255,.78);
      --card-strong: rgba(255,255,255,.92);
      --text: #0b1220;
      --muted: #667085;
      --border: rgba(15,23,42,.10);

      --primary: hsl(243 75% 59%);
      --p2: hsl(262 60% 58%);
      --p3: hsl(330 65% 55%);
      --teal: hsl(172 56% 42%);
      --blue: hsl(200 70% 50%);
      --green: hsl(152 55% 42%);

      --shadow: 0 18px 50px rgba(2,6,23,.08);
      --shadow-soft: 0 10px 26px rgba(2,6,23,.06);

      --r: 18px;
      --r2: 22px;
    }

    body{
      min-height:100vh;
      background:
        radial-gradient(1000px 600px at 10% -10%, rgba(99,102,241,.12), transparent 55%),
        radial-gradient(900px 520px at 90% 0%, rgba(236,72,153,.10), transparent 55%),
        linear-gradient(180deg, #f7f8ff, #f5f6fb);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ====== FULL FEEL (same as dashboard/projects) ====== */
    .wrap{
      max-width: 1400px;
      margin: 0 auto;
      padding-left: 12px;
      padding-right: 12px;
    }
    @media (min-width: 576px){
      .wrap{ padding-left: 18px; padding-right: 18px; }
    }

    /* ====== NAV (same as dashboard) ====== */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255,255,255,.70);
      backdrop-filter: blur(18px);
      border-bottom: 1px solid rgba(15,23,42,.08);
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      text-decoration:none;
      color: var(--text);
      font-weight: 900;
      letter-spacing: -.02em;
    }
    .brand-badge{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      display:grid;
      place-items:center;
      background: linear-gradient(135deg, var(--primary), var(--p2));
      color: #fff;
      box-shadow: 0 14px 28px rgba(99,102,241,.20);
    }
    .pill{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.80);
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 10px 18px rgba(2,6,23,.06);
      font-weight: 700;
      color: var(--text);
      user-select: none;
    }
    .pill .avatar{
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      background: linear-gradient(135deg, var(--primary), var(--p3));
      color:#fff;
    }

    /* ====== CARD BASE (same as dashboard/projects) ====== */
    .card-base{
      background: var(--card-strong);
      border: 1px solid rgba(15,23,42,.10);
      border-radius: var(--r2);
      box-shadow: var(--shadow-soft);
    }

    /* ====== HERO (same as dashboard/projects) ====== */
    .hero{
      position: relative;
      overflow: hidden;
    }
    .hero-accent{
      height: 6px;
      background: linear-gradient(90deg, var(--primary), var(--p2), var(--p3));
    }
    .hero::after{
      content:"";
      position:absolute;
      top:-90px;
      right:-90px;
      width: 260px;
      height: 260px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(99,102,241,.12), transparent 65%);
      pointer-events:none;
    }
    .hero h1{
      margin: 0;
      font-size: clamp(22px, 2vw, 30px);
      font-weight: 950;
      letter-spacing: -.03em;
    }
    .hero p{
      margin: 10px 0 0;
      color: var(--muted);
      max-width: 560px;
      font-weight: 650;
    }

    /* ====== BUTTONS (same as dashboard/projects) ====== */
    .btn-grad{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 10px 16px;
      border-radius: 14px;
      text-decoration:none;
      color:#fff;
      font-weight: 850;
      background: linear-gradient(90deg, var(--primary), var(--p2));
      box-shadow: 0 16px 30px rgba(99,102,241,.22);
      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
      border: 0;
    }
    .btn-grad:hover{
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 22px 40px rgba(99,102,241,.28);
      filter: brightness(1.03);
      color:#fff;
    }
    /* back button exactly like projects UI */
    .btn-soft{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      width: 42px;
      height: 42px;
      border-radius: 14px;
      background: rgba(15,23,42,.04);
      border: 1px solid rgba(15,23,42,.10);
      color: rgba(15,23,42,.65);
      text-decoration:none;
      transition: transform .16s ease, border-color .16s ease, background .16s ease, color .16s ease;
    }
    .btn-soft:hover{
      transform: translateY(-1px);
      border-color: rgba(99,102,241,.25);
      background: rgba(99,102,241,.06);
      color: rgba(15,23,42,.90);
    }

    /* ====== TICKETS LIST CARD (dashboard feel) ====== */
    .list-head{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(15,23,42,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.86));
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      border-top-left-radius: var(--r2);
      border-top-right-radius: var(--r2);
    }
    .title{
      margin:0;
      font-weight: 950;
      letter-spacing: -.01em;
      color: rgba(2,6,23,.92);
    }
    .sub{
      color: var(--muted);
      font-weight: 800;
      font-size: .92rem;
    }

    .search-input{
      border-radius: 999px !important;
      border: 1px solid rgba(15,23,42,.12) !important;
      background: rgba(15,23,42,.03) !important;
      padding: 10px 12px !important;
      font-weight: 800 !important;
      min-width: 280px;
    }
    .search-input:focus{
      box-shadow: 0 0 0 .25rem rgba(99,102,241,.15) !important;
      border-color: rgba(99,102,241,.30) !important;
    }

    .seg{
      display:flex;
      gap:8px;
      flex-wrap: wrap;
      align-items:center;
    }
    .seg button{
      border-radius: 999px;
      font-weight: 900;
      padding: .45rem .85rem;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.86);
      box-shadow: 0 10px 22px rgba(2,6,23,.05);
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
      cursor: pointer;
      line-height: 1;
    }
    .seg button:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(2,6,23,.08);
      border-color: rgba(99,102,241,.20);
    }
    .seg button.active{
      background: rgba(99,102,241,.10);
      border-color: rgba(99,102,241,.25);
      color: rgba(99,102,241,1);
      box-shadow: 0 12px 22px rgba(99,102,241,.12);
    }

    /* Ticket cards */
    .ticket-card{
      border-radius: 18px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.86);
      box-shadow: 0 12px 24px rgba(2,6,23,.06);
      overflow: hidden;
      cursor: pointer;
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
      position: relative;
    }
    .ticket-card:hover{
      transform: translateY(-2px);
      box-shadow: 0 18px 36px rgba(2,6,23,.10);
      border-color: rgba(99,102,241,.22);
    }

    .stripe{
      position:absolute;
      left:0; top:0; bottom:0;
      width: 6px;
      background: rgba(245,158,11,.9);
    }
    .ticket-card.open .stripe{ background: rgba(244,63,94,.92); }
    .ticket-card.resolved .stripe{ background: rgba(16,185,129,.92); }

    .meta{
      color: var(--muted);
      font-weight: 800;
      font-size: .92rem;
    }

    .pill-mini{
      border-radius: 999px;
      padding: .28rem .55rem;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.82);
      color: rgba(2,6,23,.75);
      font-weight: 900;
      font-size: .78rem;
      white-space: nowrap;
    }

    /* status pill badge */
    .badge-soft{
      border-radius: 999px;
      padding: .35rem .7rem;
      font-weight: 900;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.75);
      color: rgba(15,23,42,.72);
      display: inline-flex;
      align-items: center;
      gap: .45rem;
      white-space: nowrap;
    }
    .badge-soft.open{
      border-color: rgba(244,63,94,.28);
      background: rgba(244,63,94,.12);
      color: rgba(190,18,60,1);
    }
    .badge-soft.open::before{
      content:"";
      width: 8px; height: 8px;
      border-radius: 999px;
      background: rgba(244,63,94,1);
      box-shadow: 0 0 0 4px rgba(244,63,94,.16);
      flex: 0 0 auto;
    }
    .badge-soft.resolved{
      border-color: rgba(16,185,129,.28);
      background: rgba(16,185,129,.12);
      color: rgba(5,150,105,1);
    }
    .badge-soft.resolved::before{
      content:"";
      width: 8px; height: 8px;
      border-radius: 999px;
      background: rgba(16,185,129,1);
      box-shadow: 0 0 0 4px rgba(16,185,129,.16);
      flex: 0 0 auto;
    }

    /* Modal polish */
    .modal-content{
      border-radius: 18px;
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 22px 60px rgba(2,6,23,.20);
      overflow: hidden;
    }
    .modal-header{
      background: linear-gradient(135deg, rgba(99,102,241,1), rgba(99,102,241,.80));
      color:#fff;
      border: 0;
    }
    .modal-title{ font-weight: 950; letter-spacing: -.01em; }
    .modal-footer{
      background: rgba(248,250,252,.85);
      border-top: 1px solid rgba(15,23,42,.10);
    }
    .form-control, .form-select{
      border-radius: 14px !important;
      border-color: rgba(15,23,42,.12) !important;
      background: rgba(15,23,42,.03) !important;
      font-weight: 800 !important;
    }
    .form-control:focus, .form-select:focus{
      box-shadow: 0 0 0 .25rem rgba(99,102,241,.15) !important;
      border-color: rgba(99,102,241,.30) !important;
    }

    /* ====== FOOTER (same as dashboard) ====== */
    .footer{
      border-top: 1px solid rgba(15,23,42,.08);
      margin-top: 36px;
      padding-top: 18px;
    }
    .footer-note{
      color: var(--muted);
      font-weight: 700;
      font-size: 12px;
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .footer-note .mini{
      width: 22px;
      height: 22px;
      border-radius: 10px;
      display:grid;
      place-items:center;
      background: rgba(15,23,42,.04);
      border: 1px solid rgba(15,23,42,.08);
      color: rgba(15,23,42,.60);
    }
    .logout{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.80);
      color: rgba(15,23,42,.70);
      font-weight: 900;
      text-decoration:none;
      transition: transform .18s ease, border-color .18s ease, box-shadow .18s ease, color .18s ease;
    }
    .logout:hover{
      transform: translateY(-1px);
      border-color: rgba(99,102,241,.28);
      box-shadow: 0 12px 24px rgba(2,6,23,.08);
      color: rgba(15,23,42,.90);
    }

    @media (max-width: 768px){
      .search-input{ width:100%; min-width: unset; }
    }
  </style>
</head>

<body>

  <!-- NAV (dashboard style) -->
  <nav class="topbar">
    <div class="wrap">
      <div class="d-flex align-items-center justify-content-between" style="height:64px;">
        <a class="brand" href="{% url 'core:client_dashboard' %}">
          <span class="brand-badge"><i class="bi bi-building"></i></span>
          <span>HR Portal</span>
        </a>

        <div class="pill">
          <span class="avatar"><i class="bi bi-person-fill" style="font-size:.85rem;"></i></span>
          Client
        </div>
      </div>
    </div>
  </nav>

  <main class="wrap py-4 py-sm-5">

    <!-- HERO (projects style with back button) -->
    <section class="card-base hero">
      <div class="hero-accent"></div>

      <div class="p-4 p-sm-5 d-flex flex-column flex-sm-row align-items-start align-items-sm-center justify-content-between gap-3 gap-sm-4">
        <div class="d-flex align-items-center gap-3">
          <a class="btn-soft" href="{% url 'core:client_dashboard' %}" title="Back">
            <i class="bi bi-arrow-left"></i>
          </a>

          <div>
            <h1>Support Tickets <span style="font-size:1.05em;">ðŸ›Ÿ</span></h1>
            <p>Raise a ticket, track updates, and review past resolutions.</p>
          </div>
        </div>

        <div class="d-flex gap-2 gap-sm-3 flex-wrap">
          <button class="btn-grad" data-bs-toggle="modal" data-bs-target="#ticketModal" type="button">
            <i class="bi bi-life-preserver"></i> Raise Ticket
          </button>
        </div>
      </div>
    </section>

    <!-- TICKET LIST (dashboard card) -->
    <section class="mt-4">
      <div class="card-base overflow-hidden">
        <div class="list-head">
          <div>
            <div class="title">Your Tickets</div>
            <div class="sub">Use search or filters to find tickets quickly</div>
          </div>

          <div class="d-flex gap-2 flex-wrap align-items-center">
            <input id="ticketSearch" class="form-control search-input" placeholder="Search by title, id, categoryâ€¦" />
            <div class="seg" role="group" aria-label="Filter tickets">
              <button type="button" class="active" data-filter="all" onclick="setFilter('all')">
                <i class="bi bi-grid-1x2 me-1"></i> All
              </button>
              <button type="button" data-filter="open" onclick="setFilter('open')">
                <i class="bi bi-exclamation-circle me-1"></i> Open
              </button>
              <button type="button" data-filter="resolved" onclick="setFilter('resolved')">
                <i class="bi bi-check2-circle me-1"></i> Resolved
              </button>
            </div>
          </div>
        </div>

        <div class="p-3 p-lg-4">
          <div id="ticketFeed" class="d-flex flex-column gap-3">

            {% for t in tickets %}
            <div class="ticket-card {% if t.status == 'OPEN' %}open{% else %}resolved{% endif %}"
              data-status="{% if t.status == 'OPEN' %}open{% else %}resolved{% endif %}"
              data-text="{{ t.title }} {{ t.ticket_id }} {{ t.get_category_display }} {{ t.get_priority_display }} {{ t.get_status_display }}"
              onclick="openTicket(
                '{{ t.ticket_id }}',
                '{{ t.get_status_display }}',
                '{{ t.get_priority_display }}',
                '{{ t.get_category_display }}',
                '{{ t.description|escapejs }}'
              )">

              <div class="stripe" aria-hidden="true"></div>

              <div class="p-3 p-lg-4">
                <div class="d-flex justify-content-between align-items-start gap-2 flex-wrap">
                  <div>
                    <div class="fw-bold" style="font-size:1.02rem;">{{ t.title }}</div>
                    <div class="meta mt-1">
                      <i class="bi bi-hash me-1"></i> {{ t.ticket_id }}
                      <span class="mx-2 opacity-50">â€¢</span>
                      <span class="pill-mini"><i class="bi bi-tag me-1"></i>{{ t.get_category_display }}</span>
                      <span class="pill-mini ms-1"><i class="bi bi-flag me-1"></i>{{ t.get_priority_display }}</span>
                    </div>
                  </div>

                  {% if t.status == "OPEN" %}
                    <span class="badge-soft open">Open</span>
                  {% else %}
                    <span class="badge-soft resolved">Resolved</span>
                  {% endif %}
                </div>

                <div class="mt-2 text-muted fw-semibold">
                  {{ t.description|truncatechars:140 }}
                </div>
              </div>
            </div>
            {% empty %}
            <div class="alert alert-light border" style="border-radius:18px;">
              No tickets yet. Click <strong>Raise Ticket</strong> to create one.
            </div>
            {% endfor %}

          </div>
        </div>
      </div>
    </section>

    <!-- FOOTER (dashboard style) -->
    <footer class="footer">
      <div class="d-flex flex-column flex-sm-row align-items-center justify-content-between gap-3">
        <div class="footer-note">
          <span class="mini"><i class="bi bi-shield-check"></i></span>
          Your data is encrypted and securely stored.
        </div>
        <a class="logout" href="{% url 'logout' %}">
          <i class="bi bi-box-arrow-right"></i> Logout
        </a>
      </div>
    </footer>

  </main>

  <!-- Raise Ticket Modal -->
  <div class="modal fade" id="ticketModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title mb-0">Raise Support Ticket</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <form method="post" action="{% url 'core:support' %}">
            {% csrf_token %}

            <div class="mb-3">
              <label class="form-label fw-bold">Issue Title</label>
              <input type="text" class="form-control" name="title" required>
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">Category</label>
              <select class="form-select" name="category" required>
                <option value="LOGIN">Login</option>
                <option value="INVOICE">Invoice</option>
                <option value="PAYMENT">Payment</option>
                <option value="PROJECT">Project</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">Priority</label>
              <select class="form-select" name="priority" required>
                <option value="LOW">Low</option>
                <option value="MEDIUM" selected>Medium</option>
                <option value="HIGH">High</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">Description</label>
              <textarea class="form-control" rows="4" name="description" required></textarea>
            </div>

            <button class="btn btn-danger w-100" style="border-radius:999px; font-weight:950;" type="submit">
              <i class="bi bi-send me-1"></i> Submit Ticket
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Ticket Detail Modal -->
  <div class="modal fade" id="ticketDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title mb-0">Ticket Details</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="p-3 border rounded-4 bg-light">
                <div class="text-muted fw-bold small">Ticket ID</div>
                <div class="fw-bold" id="detailId">â€”</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="p-3 border rounded-4 bg-light">
                <div class="text-muted fw-bold small">Status</div>
                <div class="fw-bold" id="detailStatus">â€”</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="p-3 border rounded-4 bg-light">
                <div class="text-muted fw-bold small">Priority</div>
                <div class="fw-bold" id="detailPriority">â€”</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="p-3 border rounded-4 bg-light">
                <div class="text-muted fw-bold small">Category</div>
                <div class="fw-bold" id="detailCategory">â€”</div>
              </div>
            </div>
          </div>

          <hr class="my-3">

          <div class="p-3 border rounded-4 bg-white">
            <div class="text-muted fw-bold small">Description</div>
            <div class="mt-1" id="detailDescription">â€”</div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary" style="border-radius:999px; font-weight:900;" data-bs-dismiss="modal">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    function openTicket(id, status, priority, category, description) {
      document.getElementById("detailId").innerText = id;
      document.getElementById("detailStatus").innerText = status;
      document.getElementById("detailPriority").innerText = priority;
      document.getElementById("detailCategory").innerText = category;
      document.getElementById("detailDescription").innerText = description;

      new bootstrap.Modal(document.getElementById("ticketDetailModal")).show();
    }

    // Filter + search (client-side)
    let currentFilter = "all";

    function setFilter(type){
      currentFilter = type;

      document.querySelectorAll(".seg button").forEach(b => {
        b.classList.toggle("active", b.getAttribute("data-filter") === type);
      });

      applyTicketFilters();
    }

    function applyTicketFilters(){
      const q = (document.getElementById("ticketSearch").value || "").toLowerCase().trim();

      document.querySelectorAll(".ticket-card").forEach(card => {
        const status = card.getAttribute("data-status");
        const text = (card.getAttribute("data-text") || card.innerText || "").toLowerCase();

        const statusOk = (currentFilter === "all") || (status === currentFilter);
        const searchOk = !q || text.includes(q);

        card.style.display = (statusOk && searchOk) ? "" : "none";
      });
    }

    document.getElementById("ticketSearch").addEventListener("input", applyTicketFilters);

    // default
    setFilter("all");
  </script>

</body>
</html>