{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Payments | HR Portal</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'core/css/style.css' %}">

  <style>
    :root {
      /* dashboard/projects theme */
      --bg: #f6f7fb;
      --card: rgba(255, 255, 255, .78);
      --card-strong: rgba(255, 255, 255, .92);
      --text: #0b1220;
      --muted: #667085;
      --border: rgba(15, 23, 42, .10);

      --primary: hsl(243 75% 59%);
      --p2: hsl(262 60% 58%);
      --p3: hsl(330 65% 55%);
      --teal: hsl(172 56% 42%);
      --blue: hsl(200 70% 50%);
      --green: hsl(152 55% 42%);
      --amber: hsl(35 80% 55%);

      --shadow: 0 18px 50px rgba(2, 6, 23, .08);
      --shadow-soft: 0 10px 26px rgba(2, 6, 23, .06);

      --r: 18px;
      --r2: 22px;
    }

    body {
      min-height: 100vh;
      background:
        radial-gradient(1000px 600px at 10% -10%, rgba(99, 102, 241, .12), transparent 55%),
        radial-gradient(900px 520px at 90% 0%, rgba(236, 72, 153, .10), transparent 55%),
        linear-gradient(180deg, #f7f8ff, #f5f6fb);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ====== FULL FEEL ====== */
    .wrap {
      max-width: 1400px;
      margin: 0 auto;
      padding-left: 12px;
      padding-right: 12px;
    }

    @media (min-width: 576px) {
      .wrap {
        padding-left: 18px;
        padding-right: 18px;
      }
    }

    /* ====== NAV (dashboard) ====== */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255, 255, 255, .70);
      backdrop-filter: blur(18px);
      border-bottom: 1px solid rgba(15, 23, 42, .08);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: var(--text);
      font-weight: 900;
      letter-spacing: -.02em;
    }

    .brand-badge {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      display: grid;
      place-items: center;
      background: linear-gradient(135deg, var(--primary), var(--p2));
      color: #fff;
      box-shadow: 0 14px 28px rgba(99, 102, 241, .20);
    }

    .pill {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(255, 255, 255, .80);
      border: 1px solid rgba(15, 23, 42, .10);
      box-shadow: 0 10px 18px rgba(2, 6, 23, .06);
      font-weight: 700;
      color: var(--text);
      user-select: none;
    }

    .pill .avatar {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      background: linear-gradient(135deg, var(--primary), var(--p3));
      color: #fff;
    }

    /* ====== BASE CARD ====== */
    .card-base {
      background: var(--card-strong);
      border: 1px solid rgba(15, 23, 42, .10);
      border-radius: var(--r2);
      box-shadow: var(--shadow-soft);
    }

    /* ====== HERO ====== */
    .hero {
      position: relative;
      overflow: hidden;
    }

    .hero-accent {
      height: 6px;
      background: linear-gradient(90deg, var(--primary), var(--p2), var(--p3));
    }

    .hero::after {
      content: "";
      position: absolute;
      top: -90px;
      right: -90px;
      width: 260px;
      height: 260px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(99, 102, 241, .12), transparent 65%);
      pointer-events: none;
    }

    .hero h1 {
      margin: 0;
      font-size: clamp(22px, 2vw, 30px);
      font-weight: 950;
      letter-spacing: -.03em;
    }

    .hero p {
      margin: 10px 0 0;
      color: var(--muted);
      max-width: 560px;
      font-weight: 650;
    }

    /* ====== BUTTONS ====== */
    .btn-grad {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      border-radius: 14px;
      text-decoration: none;
      color: #fff;
      font-weight: 850;
      background: linear-gradient(90deg, var(--primary), var(--p2));
      box-shadow: 0 16px 30px rgba(99, 102, 241, .22);
      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
      border: 0;
    }

    .btn-grad:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 22px 40px rgba(99, 102, 241, .28);
      filter: brightness(1.03);
      color: #fff;
    }

    /* back button like projects ui */
    .btn-soft {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 42px;
      height: 42px;
      border-radius: 14px;
      background: rgba(15, 23, 42, .04);
      border: 1px solid rgba(15, 23, 42, .10);
      color: rgba(15, 23, 42, .65);
      text-decoration: none;
      transition: transform .16s ease, border-color .16s ease, background .16s ease, color .16s ease;
    }

    .btn-soft:hover {
      transform: translateY(-1px);
      border-color: rgba(99, 102, 241, .25);
      background: rgba(99, 102, 241, .06);
      color: rgba(15, 23, 42, .90);
    }

    /* ====== STATS ====== */
    .stat {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 18px;
      cursor: default;
      transition: transform .18s ease, box-shadow .18s ease;
    }

    .stat:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: var(--shadow);
    }

    .stat-ic {
      width: 52px;
      height: 52px;
      border-radius: 18px;
      display: grid;
      place-items: center;
      color: #fff;
      font-size: 20px;
      box-shadow: 0 14px 26px rgba(2, 6, 23, .10);
    }

    .s1 {
      background: linear-gradient(135deg, var(--green), var(--teal));
    }

    .s2 {
      background: linear-gradient(135deg, var(--amber), var(--p3));
    }

    .s3 {
      background: linear-gradient(135deg, var(--primary), var(--p2));
    }

    .stat .value {
      font-size: 28px;
      line-height: 1.05;
      font-weight: 950;
      letter-spacing: -.02em;
    }

    .stat .label {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 750;
    }

    /* ====== LIST HEAD ====== */
    .list-head {
      padding: 14px 16px;
      border-bottom: 1px solid rgba(15, 23, 42, .08);
      background: linear-gradient(180deg, rgba(255, 255, 255, .98), rgba(255, 255, 255, .86));
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      border-top-left-radius: var(--r2);
      border-top-right-radius: var(--r2);
    }

    .title {
      margin: 0;
      font-weight: 950;
      letter-spacing: -.01em;
      color: rgba(2, 6, 23, .92);
    }

    .sub {
      color: var(--muted);
      font-weight: 800;
      font-size: .92rem;
    }

    /* ====== PAYMENT CARD ====== */
    .p-card {
      border-radius: var(--r2);
      background: rgba(255, 255, 255, .86);
      border: 1px solid rgba(15, 23, 42, .10);
      box-shadow: var(--shadow-soft);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      position: relative;
      overflow: hidden;
      height: 100%;
    }

    .p-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
      border-color: rgba(99, 102, 241, .22);
    }

    .p-id {
      font-weight: 950;
      color: rgba(2, 6, 23, .92);
    }

    .p-muted {
      color: rgba(100, 116, 139, .95);
      font-weight: 750;
    }

    .p-amount {
      font-weight: 950;
      color: rgba(2, 6, 23, .92);
      font-size: 1.25rem;
    }

    .hide-btn {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, .85);
      border: 1px solid rgba(15, 23, 42, .12);
      color: rgba(2, 6, 23, .88);
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }

    .hide-btn:hover {
      transform: scale(1.04);
      background: rgba(248, 250, 252, 1);
      border-color: rgba(99, 102, 241, .22);
    }

    .btn,
    .form-control,
    .form-select {
      border-radius: 14px;
    }

    .btn-pill {
      border-radius: 999px;
      font-weight: 900;
    }

    /* =======================
       Add Payment Modal ONLY
       ======================= */
    #addPaymentModal .modal-content {
      border-radius: 22px;
      border: 1px solid rgba(15, 23, 42, .10);
      box-shadow: 0 18px 60px rgba(2, 6, 23, .25);
      overflow: hidden;
    }

    #addPaymentModal .modal-header {
      background: linear-gradient(135deg, rgba(99, 102, 241, 1), rgba(99, 102, 241, .80));
      color: #fff;
      border: 0;
    }

    #addPaymentModal .modal-title {
      font-weight: 950;
    }

    #addPaymentModal .form-control,
    #addPaymentModal .form-select {
      border-radius: 14px !important;
      border-color: rgba(15, 23, 42, .12) !important;
      background: rgba(15, 23, 42, .03) !important;
      font-weight: 800 !important;
    }

    #addPaymentModal .form-control:focus,
    #addPaymentModal .form-select:focus {
      box-shadow: 0 0 0 .25rem rgba(99, 102, 241, .15) !important;
      border-color: rgba(99, 102, 241, .30) !important;
    }

    /* =======================
       Pay Now Modal (FIXED)
       ======================= */
    #payNowModal .modal-dialog {
      max-width: 640px;
    }

    #payNowModal .modal-content {
      border-radius: 26px;
      border: 1px solid rgba(15, 23, 42, .12);
      overflow: hidden;
      box-shadow: 0 40px 100px rgba(2, 6, 23, .28);
      background: rgba(255, 255, 255, .92);
    }

    #payNowModal .modal-header {
      border: 0;
      padding: 18px 20px 14px;
      background: linear-gradient(135deg, var(--primary), var(--p2), var(--p3));
      color: #fff;
    }

    /* IMPORTANT: make title/meta not overlap close button */
    #payNowModal .pay-head {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      width: 100%;
    }

    #payNowModal .pay-head .left {
      min-width: 0;
    }

    #payNowModal .modal-title {
      font-weight: 950;
      letter-spacing: -.02em;
      margin: 0;
      line-height: 1.15;
    }

    #payNowModal #payNowMeta {
      display: block;
      margin-top: 6px;
      font-weight: 800;
      opacity: .88;
      line-height: 1.2;
      white-space: normal;
      /* allow wrap */
      overflow-wrap: anywhere;
      /* never hide */
    }

    #payNowModal .btn-close {
      filter: invert(1);
      opacity: .9;
      flex: 0 0 auto;
      margin: 2px 0 0 0;
    }

    #payNowModal .modal-body {
      padding: 16px 20px 18px;
    }

    #payNowModal .form-label {
      font-size: 12px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: rgba(2, 6, 23, .65);
      font-weight: 950;
    }

    #payNowModal .form-control,
    #payNowModal .form-select {
      border-radius: 16px !important;
      border: 1px solid rgba(15, 23, 42, .12) !important;
      background: rgba(15, 23, 42, .03) !important;
      font-weight: 850 !important;
      padding: 12px 14px !important;
    }

    #payNowModal .form-control:focus,
    #payNowModal .form-select:focus {
      box-shadow: 0 0 0 4px rgba(99, 102, 241, .14) !important;
      border-color: rgba(99, 102, 241, .40) !important;
    }

    /* button */
    #payNowModal #payBtn {
      border: 0;
      border-radius: 18px !important;
      padding: 13px 14px !important;
      font-weight: 950;
      background: linear-gradient(90deg, var(--primary), var(--p2));
      box-shadow: 0 18px 40px rgba(99, 102, 241, .30);
      transition: transform .18s ease, box-shadow .18s ease;
    }

    #payNowModal #payBtn:hover {
      transform: translateY(-1px);
      box-shadow: 0 26px 60px rgba(99, 102, 241, .34);
    }

    /* secure note */
    #payNowModal .secure-note {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 10px;
      color: rgba(100, 116, 139, .95);
      font-size: 12px;
      font-weight: 850;
    }

    #payNowModal .secure-note i {
      color: rgba(99, 102, 241, .85);
    }

    /* Processing overlay - match radius */
    .processing {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, .88);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 10px;
      border-radius: 26px;
      z-index: 10;
      backdrop-filter: blur(6px);
    }

    .processing.show {
      display: flex;
    }

    /* Toast */
    .toast-container {
      z-index: 2000;
    }

    .toast {
      border-radius: 16px;
      box-shadow: 0 18px 40px rgba(2, 6, 23, .22);
    }

    /* ====== FOOTER (dashboard) ====== */
    .footer {
      border-top: 1px solid rgba(15, 23, 42, .08);
      margin-top: 36px;
      padding-top: 18px;
    }

    .footer-note {
      color: var(--muted);
      font-weight: 700;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .footer-note .mini {
      width: 22px;
      height: 22px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      background: rgba(15, 23, 42, .04);
      border: 1px solid rgba(15, 23, 42, .08);
      color: rgba(15, 23, 42, .60);
    }

    .logout {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 14px;
      border: 1px solid rgba(15, 23, 42, .10);
      background: rgba(255, 255, 255, .80);
      color: rgba(15, 23, 42, .70);
      font-weight: 900;
      text-decoration: none;
      transition: transform .18s ease, border-color .18s ease, box-shadow .18s ease, color .18s ease;
    }

    .logout:hover {
      transform: translateY(-1px);
      border-color: rgba(99, 102, 241, .28);
      box-shadow: 0 12px 24px rgba(2, 6, 23, .08);
      color: rgba(15, 23, 42, .90);
    }
  </style>
</head>

<body>

  <!-- NAV (dashboard style) -->
  <nav class="topbar">
    <div class="wrap">
      <div class="d-flex align-items-center justify-content-between" style="height:64px;">
        <a class="brand" href="{% url 'core:client_dashboard' %}">
          <span class="brand-badge"><i class="bi bi-building"></i></span>
          <span>HR Portal</span>
        </a>

        <div class="pill">
          <span class="avatar"><i class="bi bi-person-fill" style="font-size:.85rem;"></i></span>
          Client
        </div>
      </div>
    </div>
  </nav>

  <main class="wrap py-4 py-sm-5">

    <!-- HERO -->
    <section class="card-base hero">
      <div class="hero-accent"></div>

      <div
        class="p-4 p-sm-5 d-flex flex-column flex-sm-row align-items-start align-items-sm-center justify-content-between gap-3 gap-sm-4">
        <div class="d-flex align-items-center gap-3">
          <a class="btn-soft" href="{% url 'core:client_dashboard' %}" title="Back">
            <i class="bi bi-arrow-left"></i>
          </a>

          <div>
            <h1>Payments <span style="font-size:1.05em;">ðŸ’³</span></h1>
            <p>Track invoices, pay pending items (dummy), and view history.</p>
          </div>
        </div>

        <div class="d-flex gap-2 gap-sm-3 flex-wrap">
          <button class="btn-grad" type="button" onclick="resetHiddenPayments()">
            <i class="bi bi-arrow-counterclockwise"></i> Show Hidden
          </button>
          <button class="btn-grad" data-bs-toggle="modal" data-bs-target="#addPaymentModal" type="button">
            <i class="bi bi-plus-circle"></i> Add Payment
          </button>
        </div>
      </div>
    </section>

    <!-- STATS -->
    <section class="mt-4">
      <div class="row g-3 g-sm-4">
        <div class="col-12 col-md-4">
          <div class="card-base stat">
            <div class="stat-ic s1"><i class="bi bi-check2-circle"></i></div>
            <div>
              <div class="value">â‚¹{{ total_paid }}</div>
              <div class="label">Total Paid</div>
            </div>
          </div>
        </div>

        <div class="col-12 col-md-4">
          <div class="card-base stat">
            <div class="stat-ic s2"><i class="bi bi-hourglass-split"></i></div>
            <div>
              <div class="value">â‚¹{{ pending }}</div>
              <div class="label">Pending Payments</div>
            </div>
          </div>
        </div>

        <div class="col-12 col-md-4">
          <div class="card-base stat">
            <div class="stat-ic s3"><i class="bi bi-clock"></i></div>
            <div>
              {% if last_payment %}
              <div class="value">â‚¹{{ last_payment.amount_paid }}</div>
              <div class="label">Last Payment â€¢ {{ last_payment.payment_date|date:"d M Y" }}</div>
              {% else %}
              <div class="value">â€”</div>
              <div class="label">Last Payment</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PAYMENTS LIST -->
    <section class="mt-4">
      <div class="card-base overflow-hidden">
        <div class="list-head">
          <div>
            <div class="title">Payment History</div>
            <div class="sub">Pending payments can be paid (dummy) or deleted</div>
          </div>
        </div>

        <div class="p-3 p-lg-4">
          <div class="row g-3 g-md-4" id="paymentCards">
            {% for p in payments %}
            <div class="col-12 col-md-6 payment-item" data-payment-id="{{ p.id }}">
              <div class="p-card p-3 p-lg-4">

                <div class="d-flex justify-content-between align-items-start gap-2 flex-wrap">
                  <div>
                    <div class="p-id">{{ p.payment_id }}</div>
                    <div class="p-muted small">Invoice: <strong>INV-{{ p.invoice.id }}</strong></div>
                  </div>

                  <div class="d-flex align-items-center gap-2">
                    {% if p.status == "COMPLETED" %}
                    <span class="badge rounded-pill text-bg-success px-3 py-2 fw-semibold">
                      <i class="bi bi-check2-circle me-1"></i> Completed
                    </span>
                    {% else %}
                    <span class="badge rounded-pill text-bg-warning px-3 py-2 fw-semibold text-dark">
                      <i class="bi bi-hourglass-split me-1"></i> Pending
                    </span>
                    {% endif %}

                    <button type="button" class="hide-btn" title="Hide from list" onclick="hidePaymentPersistent(this)">
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </div>
                </div>

                <hr class="my-3">

                <div class="d-flex justify-content-between align-items-center">
                  <div class="small">
                    <div class="mb-1">
                      <i class="bi bi-wallet2 me-1"></i>
                      <span class="fw-semibold">{{ p.get_method_display }}</span>
                    </div>
                    <div class="text-muted fw-semibold">
                      <i class="bi bi-calendar-event me-1"></i>
                      {{ p.payment_date|date:"Y-m-d" }}
                    </div>
                  </div>

                  <div class="text-end">
                    <div class="p-amount">â‚¹{{ p.amount_paid }}</div>

                    <div class="d-flex gap-2 justify-content-end mt-2">
                      {% if p.status == "PENDING" %}
                      <button class="btn btn-primary btn-sm btn-pill" data-bs-toggle="modal"
                        data-bs-target="#payNowModal" data-pay-url="{% url 'core:payment_pay_now' p.id %}"
                        data-pay-id="{{ p.payment_id }}" data-pay-amount="{{ p.amount_paid }}">
                        Pay Now
                      </button>

                      <form method="POST" action="{% url 'core:payment_delete' p.id %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger btn-sm btn-pill"
                          onclick="return confirm('Delete {{ p.payment_id }}?');">
                          <i class="bi bi-trash3 me-1"></i> Delete
                        </button>
                      </form>
                      {% else %}
                      <button class="btn btn-outline-success btn-sm btn-pill" disabled>Paid</button>
                      {% endif %}
                    </div>
                  </div>
                </div>

              </div>
            </div>
            {% empty %}
            <div class="col-12">
              <div class="alert alert-info mb-0" style="border-radius:18px;">No payments found.</div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </section>

    <!-- FOOTER -->
    <footer class="footer">
      <div class="d-flex flex-column flex-sm-row align-items-center justify-content-between gap-3">
        <div class="footer-note">
          <span class="mini"><i class="bi bi-shield-check"></i></span>
          Your data is encrypted and securely stored.
        </div>
        <a class="logout" href="{% url 'logout' %}">
          <i class="bi bi-box-arrow-right"></i> Logout
        </a>
      </div>
    </footer>

  </main>

  <!-- Toasts -->
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="payToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive"
      aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="payToastMsg">Payment successful.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>

    <div id="payToastErr" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive"
      aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="payToastErrMsg">Payment failed.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- Add Payment Modal -->
  <div class="modal fade" id="addPaymentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-0">
        <div class="modal-header">
          <h5 class="modal-title">Add Payment</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body p-3 p-lg-4">
          <form method="POST" action="{% url 'core:payment_create' %}">
            {% csrf_token %}

            <div class="mb-3">
              <label class="form-label fw-bold">Payment ID</label>
              <input type="text" class="form-control" name="payment_id" placeholder="PAY-201" required>
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">Invoice</label>
              <select class="form-select" name="invoice_id" required>
                <option value="">Select invoice</option>
                {% for inv in invoices %}
                <option value="{{ inv.id }}">
                  INV-{{ inv.id }} ({{ inv.project.name }}) - â‚¹{{ inv.amount }}
                </option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">Amount</label>
              <input type="number" class="form-control" name="amount_paid" step="0.01" required>
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">Payment Date</label>
              <input type="date" class="form-control" name="payment_date" required>
            </div>

            <button type="submit" class="btn btn-success w-100 btn-pill">
              <i class="bi bi-check2-circle me-1"></i> Save Payment
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Pay Now Modal -->
  <div class="modal fade" id="payNowModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content position-relative">

        <div class="processing" id="processingOverlay">
          <div class="spinner-border" role="status"></div>
          <div class="fw-semibold">Processing paymentâ€¦</div>
          <div class="text-muted small">This is a dummy flow (no real money).</div>
        </div>

        <div class="modal-header">
          <div class="pay-head">
            <div class="left">
              <h5 class="modal-title">Pay Now</h5>
              <small id="payNowMeta">â€”</small>
            </div>
            <button class="btn-close" id="payModalCloseBtn" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
        </div>

        <div class="modal-body">
          <form id="payNowForm">
            {% csrf_token %}

            <div class="mb-3">
              <label class="form-label">Payment Method</label>
              <select class="form-select" id="payMethod" name="method" required>
                <option value="CARD">Credit Card</option>
                <option value="UPI">UPI</option>
                <option value="BANK">Bank Transfer</option>
              </select>
            </div>

            <div id="cardFields">
              <div class="mb-3">
                <label class="form-label">Card Number</label>
                <input type="text" class="form-control" name="card_number" placeholder="1234 5678 9012 3456">
              </div>
              <div class="row g-2">
                <div class="col-12 col-sm-6">
                  <label class="form-label">Expiry (MM/YY)</label>
                  <input type="text" class="form-control" name="card_expiry" placeholder="08/28">
                </div>
                <div class="col-12 col-sm-6">
                  <label class="form-label">CVV</label>
                  <input type="password" class="form-control" name="card_cvv" placeholder="123">
                </div>
              </div>
            </div>

            <div id="upiFields" class="d-none">
              <div class="mb-3">
                <label class="form-label">UPI ID</label>
                <input type="text" class="form-control" name="upi_id" placeholder="name@bank">
              </div>
              <div class="mb-3">
                <label class="form-label">UPI PIN</label>
                <input type="password" class="form-control" name="upi_pin" placeholder="****">
              </div>
            </div>

            <div id="bankFields" class="d-none">
              <div class="mb-3">
                <label class="form-label">Bank Reference No.</label>
                <input type="text" class="form-control" name="bank_ref" placeholder="UTR / Ref No">
              </div>
            </div>

            <button type="submit" class="btn btn-primary w-100 mt-3" id="payBtn">
              <i class="bi bi-credit-card me-1"></i> Pay (Dummy)
            </button>

            <div class="secure-note">
              <i class="bi bi-shield-lock"></i>
              <span>Secure checkout (dummy flow)</span>
            </div>
          </form>
        </div>

        <div class="modal-footer px-3 px-lg-4 py-3">
          <button type="button" class="btn btn-outline-secondary btn-pill" data-bs-dismiss="modal"
            id="payModalCloseBtn2">
            Close
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    function csrfInput() {
      return document.querySelector('#payNowForm input[name="csrfmiddlewaretoken"]');
    }

    function getCSRFToken() {
      const el = csrfInput();
      return el ? el.value : "";
    }

    const payNowModalEl = document.getElementById("payNowModal");
    const payNowForm = document.getElementById("payNowForm");
    const payMethod = document.getElementById("payMethod");
    const cardFields = document.getElementById("cardFields");
    const upiFields = document.getElementById("upiFields");
    const bankFields = document.getElementById("bankFields");
    const payNowMeta = document.getElementById("payNowMeta");
    const payBtn = document.getElementById("payBtn");
    const processingOverlay = document.getElementById("processingOverlay");
    const payModalCloseBtn = document.getElementById("payModalCloseBtn");
    const payModalCloseBtn2 = document.getElementById("payModalCloseBtn2");

    const toastOk = new bootstrap.Toast(document.getElementById("payToast"), { delay: 3000 });
    const toastErr = new bootstrap.Toast(document.getElementById("payToastErr"), { delay: 4500 });

    let currentPayUrl = null;

    function toggleMethodFields() {
      const m = payMethod.value;
      cardFields.classList.toggle("d-none", m !== "CARD");
      upiFields.classList.toggle("d-none", m !== "UPI");
      bankFields.classList.toggle("d-none", m !== "BANK");
    }
    toggleMethodFields();
    payMethod.addEventListener("change", toggleMethodFields);

    // âœ… When modal opens
    payNowModalEl.addEventListener("show.bs.modal", function (event) {
      const button = event.relatedTarget;
      currentPayUrl = button.getAttribute("data-pay-url");

      const pid = button.getAttribute("data-pay-id");
      const amt = button.getAttribute("data-pay-amount");
      payNowMeta.textContent = `${pid} â€¢ â‚¹${amt}`;

      // âœ… IMPORTANT: preserve CSRF token before reset
      const tokenBefore = getCSRFToken();
      payNowForm.reset();
      const csrfEl = csrfInput();
      if (csrfEl) csrfEl.value = tokenBefore; // restore after reset

      payMethod.value = "CARD";
      toggleMethodFields();

      processingOverlay.classList.remove("show");
      payBtn.disabled = false;
      payModalCloseBtn.disabled = false;
      if (payModalCloseBtn2) payModalCloseBtn2.disabled = false;
    });

    // âœ… Pay submit
    payNowForm.addEventListener("submit", async function (e) {
      e.preventDefault();
      if (!currentPayUrl) return;

      processingOverlay.classList.add("show");
      payBtn.disabled = true;
      payModalCloseBtn.disabled = true;
      if (payModalCloseBtn2) payModalCloseBtn2.disabled = true;

      const formData = new FormData(payNowForm);

      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), 12000);

      try {
        const resp = await fetch(currentPayUrl, {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": getCSRFToken(),
          },
          credentials: "same-origin",
          body: formData,
          signal: controller.signal,
        });

        const ct = resp.headers.get("content-type") || "";
        let data = {};

        if (ct.includes("application/json")) {
          data = await resp.json();
        } else {
          // Usually login page / CSRF / 403 / 500 HTML
          const text = await resp.text();
          throw new Error(`Non-JSON (HTTP ${resp.status}). ${text.slice(0, 160)}`);
        }

        if (!resp.ok || !data.ok) {
          document.getElementById("payToastErrMsg").textContent =
            data.message || `Payment failed (HTTP ${resp.status}).`;
          toastErr.show();
          return;
        }

        document.getElementById("payToastMsg").textContent = data.message || "Payment successful.";
        toastOk.show();

        bootstrap.Modal.getInstance(payNowModalEl).hide();
        setTimeout(() => window.location.reload(), 900);

      } catch (err) {
        console.log("PAY ERROR:", err);
        document.getElementById("payToastErrMsg").textContent =
          err.name === "AbortError"
            ? "Server not responding (timeout). Check Django terminal."
            : (err.message || "Payment failed. Check Django terminal/console.");
        toastErr.show();

      } finally {
        clearTimeout(timer);
        processingOverlay.classList.remove("show");
        payBtn.disabled = false;
        payModalCloseBtn.disabled = false;
        if (payModalCloseBtn2) payModalCloseBtn2.disabled = false;
      }
    });

    // card number formatting
    payNowForm.addEventListener("input", (e) => {
      if (e.target && e.target.name === "card_number") {
        let v = e.target.value.replace(/\D/g, "").slice(0, 16);
        e.target.value = v.replace(/(.{4})/g, "$1 ").trim();
      }
    });

    // ---- keep your hide payments logic if needed ----
    const HIDDEN_PAYMENTS_KEY = "hiddenPayments";

    function getHiddenPayments() {
      try { return JSON.parse(localStorage.getItem(HIDDEN_PAYMENTS_KEY)) || []; }
      catch { return []; }
    }
    function setHiddenPayments(arr) {
      localStorage.setItem(HIDDEN_PAYMENTS_KEY, JSON.stringify(arr));
    }
    function hidePaymentPersistent(btn) {
      const col = btn.closest(".payment-item");
      if (!col) return;
      const pid = col.getAttribute("data-payment-id");
      if (!pid) return;

      const hidden = new Set(getHiddenPayments());
      hidden.add(pid);
      setHiddenPayments([...hidden]);

      col.style.transition = "opacity .25s ease, transform .25s ease";
      col.style.opacity = "0";
      col.style.transform = "scale(.98)";
      setTimeout(() => col.remove(), 250);
    }
    function resetHiddenPayments() {
      localStorage.removeItem(HIDDEN_PAYMENTS_KEY);
      window.location.reload();
    }
    document.addEventListener("DOMContentLoaded", () => {
      const hidden = new Set(getHiddenPayments());
      document.querySelectorAll(".payment-item").forEach((el) => {
        const pid = el.getAttribute("data-payment-id");
        if (hidden.has(pid)) el.remove();
      });
    });
  </script>

</body>

</html>