{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Payments | HR Portal</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: radial-gradient(1200px 600px at 10% 10%, #e0f2fe 0%, transparent 55%),
        radial-gradient(900px 500px at 90% 15%, #ede9fe 0%, transparent 55%),
        #f6f7fb;
    }

    .navbar {
      background: linear-gradient(90deg, #1e3a8a, #1d4ed8);
      box-shadow: 0 10px 30px rgba(2, 6, 23, .12);
    }
    .navbar .navbar-brand {
      color: #fff;
      font-weight: 700;
      letter-spacing: .2px;
    }
    .navbar span {
      color: #e2e8f0;
      font-weight: 500;
    }

    .page-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 18px;
      border-radius: 18px;
      background: rgba(255, 255, 255, .75);
      box-shadow: 0 10px 28px rgba(2, 6, 23, .08);
      backdrop-filter: blur(8px);
      gap: 12px;
      flex-wrap: wrap;
    }

    .page-title {
      display: flex;
      gap: 12px;
      align-items: center;
      min-width: 260px;
    }
    .page-title .icon {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #dbeafe, #e0f2fe);
      color: #1e3a8a;
      box-shadow: inset 0 0 0 1px rgba(30, 58, 138, .12);
    }

    h2 {
      font-weight: 800;
      margin: 0;
    }

    .btn-success {
      border-radius: 14px;
      padding: 10px 14px;
      box-shadow: 0 10px 18px rgba(34, 197, 94, .18);
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .btn-success:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 26px rgba(34, 197, 94, .22);
    }

    .btn-primary,
    .btn-outline-success,
    .btn-outline-danger,
    .btn-outline-secondary {
      border-radius: 14px;
    }

    /* Stat cards */
    .stat {
      border-radius: 20px;
      background: rgba(255, 255, 255, .8);
      box-shadow: 0 12px 30px rgba(2, 6, 23, .08);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(148, 163, 184, .22);
      overflow: hidden;
    }
    .stat .topline {
      height: 4px;
      background: linear-gradient(90deg, #22c55e, #60a5fa, #a78bfa);
    }
    .stat .inner {
      padding: 16px;
    }
    .stat .label {
      color: #64748b;
      font-weight: 600;
      font-size: .92rem;
    }
    .stat .value {
      font-weight: 900;
      letter-spacing: .2px;
      margin: 6px 0 0;
    }
    .stat .sub {
      color: #94a3b8;
      font-size: .85rem;
    }

    .chip {
      font-weight: 700;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: .75rem;
      letter-spacing: .4px;
      text-transform: uppercase;
      white-space: nowrap;
    }

    /* Payment card */
    .p-card {
      border-radius: 22px;
      background: rgba(255, 255, 255, .85);
      box-shadow: 0 12px 30px rgba(2, 6, 23, .08);
      border: 1px solid rgba(148, 163, 184, .2);
      transition: transform .18s ease, box-shadow .18s ease;
      position: relative;
    }
    .p-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 18px 40px rgba(2, 6, 23, .12);
    }
    .p-id {
      font-weight: 900;
      color: #0f172a;
    }
    .p-muted {
      color: #64748b;
    }
    .p-amount {
      font-weight: 900;
      color: #1e3a8a;
      font-size: 1.25rem;
    }
    .p-meta i {
      color: #1e3a8a;
    }

    /* ❌ Hide button */
    .hide-btn{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,.8);
      border: 1px solid rgba(148,163,184,.35);
      color: #0f172a;
      transition: transform .12s ease, background .12s ease;
    }
    .hide-btn:hover{
      transform: scale(1.04);
      background: rgba(248,250,252,1);
    }

    /* Modal */
    .modal-content {
      border-radius: 22px;
      border: 0;
      box-shadow: 0 18px 60px rgba(2, 6, 23, .25);
    }
    .modal-header { border: 0; }
    .modal-title { font-weight: 900; }

    .form-control,
    .form-select {
      border-radius: 14px;
    }
    .form-control:focus,
    .form-select:focus {
      box-shadow: 0 0 0 .25rem rgba(59, 130, 246, .18);
    }

    /* Processing overlay */
    .processing {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, .88);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 10px;
      border-radius: 22px;
      z-index: 10;
      backdrop-filter: blur(4px);
    }
    .processing.show { display: flex; }

    /* Toast */
    .toast-container { z-index: 2000; }
    .toast {
      border-radius: 16px;
      box-shadow: 0 18px 40px rgba(2, 6, 23, .22);
    }
  </style>
</head>

<body>

  <!-- Navbar -->
  <nav class="navbar py-2">
    <div class="container d-flex justify-content-between align-items-center">
      <a class="navbar-brand d-flex align-items-center" href="{% url 'core:client_dashboard' %}">
        <i class="bi bi-building me-2"></i> HR Portal
      </a>
      <span><i class="bi bi-person-circle me-1"></i> Client</span>
    </div>
  </nav>

  <!-- Toasts -->
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="payToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive"
      aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="payToastMsg">Payment successful.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>

    <div id="payToastErr" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive"
      aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="payToastErrMsg">Payment failed.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <div class="container my-4 my-md-5">

    <!-- Page Header -->
    <div class="page-head mb-4">
      <div class="page-title">
        <div class="icon"><i class="bi bi-receipt-cutoff fs-5"></i></div>
        <div>
          <h2>Payments</h2>
          <div class="text-muted small">Track invoices, pay pending items (dummy), and view history.</div>
        </div>
      </div>

      <!-- ✅ Actions (Back + Show Hidden + Add) -->
      <div class="d-flex gap-2 ms-auto">
        <a href="{% url 'core:client_dashboard' %}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-1"></i> Dashboard
        </a>

        <button class="btn btn-outline-secondary" type="button" onclick="resetHiddenPayments()">
          <i class="bi bi-arrow-counterclockwise me-1"></i> Show Hidden
        </button>

        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
          <i class="bi bi-plus-circle me-1"></i> Add Payment
        </button>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="row g-3 g-md-4 mb-4">
      <div class="col-md-4">
        <div class="stat">
          <div class="topline"></div>
          <div class="inner">
            <div class="d-flex align-items-center justify-content-between">
              <div class="label">Total Paid</div>
              <span class="chip bg-success-subtle text-success"><i class="bi bi-check2-circle me-1"></i>Settled</span>
            </div>
            <div class="value text-success fs-3">₹{{ total_paid }}</div>
            <div class="sub">Sum of completed payments</div>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="stat">
          <div class="topline"></div>
          <div class="inner">
            <div class="d-flex align-items-center justify-content-between">
              <div class="label">Pending Payments</div>
              <span class="chip bg-warning-subtle text-warning"><i class="bi bi-hourglass-split me-1"></i>Pending</span>
            </div>
            <div class="value text-warning fs-3">₹{{ pending }}</div>
            <div class="sub">Total amount waiting to be paid</div>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="stat">
          <div class="topline"></div>
          <div class="inner">
            <div class="d-flex align-items-center justify-content-between">
              <div class="label">Last Payment</div>
              <span class="chip bg-info-subtle text-info"><i class="bi bi-clock me-1"></i>Latest</span>
            </div>
            {% if last_payment %}
              <div class="value fs-4">₹{{ last_payment.amount_paid }}</div>
              <div class="sub">{{ last_payment.payment_date|date:"d M Y" }}</div>
            {% else %}
              <div class="value fs-4">—</div>
              <div class="sub">No completed payment yet</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Payments List -->
    <div class="row g-3 g-md-4" id="paymentCards">
      {% for p in payments %}
      <div class="col-md-6 payment-item" data-payment-id="{{ p.id }}">
        <div class="p-card p-3">

          <!-- top row -->
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="p-id">{{ p.payment_id }}</div>
              <div class="p-muted small">Invoice: <strong>INV-{{ p.invoice.id }}</strong></div>
            </div>

            <div class="d-flex align-items-center gap-2">
              {% if p.status == "COMPLETED" %}
                <span class="chip bg-success text-white"><i class="bi bi-check2-circle me-1"></i>Completed</span>
              {% else %}
                <span class="chip bg-warning text-dark"><i class="bi bi-hourglass-split me-1"></i>Pending</span>
              {% endif %}

              <!-- ✅ Hide (frontend only) -->
              <button type="button" class="hide-btn" title="Hide from list" onclick="hidePaymentPersistent(this)">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
          </div>

          <hr class="my-3">

          <div class="d-flex justify-content-between align-items-center">
            <div class="p-meta small">
              <div class="mb-1"><i class="bi bi-wallet2 me-1"></i> {{ p.get_method_display }}</div>
              <div><i class="bi bi-calendar-event me-1"></i> {{ p.payment_date|date:"Y-m-d" }}</div>
            </div>

            <div class="text-end">
              <div class="p-amount">₹{{ p.amount_paid }}</div>

              <!-- ✅ Buttons -->
              <div class="d-flex gap-2 justify-content-end mt-2">

                {% if p.status == "PENDING" %}
                  <button class="btn btn-primary btn-sm"
                    data-bs-toggle="modal" data-bs-target="#payNowModal"
                    data-pay-url="{% url 'core:payment_pay_now' p.id %}"
                    data-pay-id="{{ p.payment_id }}"
                    data-pay-amount="{{ p.amount_paid }}">
                    Pay Now
                  </button>

                  <!-- (Optional) DB delete only for pending -->
                  <form method="POST" action="{% url 'core:payment_delete' p.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger btn-sm"
                      onclick="return confirm('Delete {{ p.payment_id }}?');">
                      <i class="bi bi-trash3 me-1"></i> Delete
                    </button>
                  </form>
                {% else %}
                  <button class="btn btn-outline-success btn-sm" disabled>
                    Paid
                  </button>
                {% endif %}

              </div>
            </div>

          </div>
        </div>
      </div>
      {% empty %}
      <div class="col-12">
        <div class="alert alert-info mb-0">No payments found.</div>
      </div>
      {% endfor %}
    </div>

    <!-- Add Payment Modal -->
    <div class="modal fade" id="addPaymentModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-3">
          <div class="modal-header">
            <h5 class="modal-title">Add Payment</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <form method="POST" action="{% url 'core:payment_create' %}">
              {% csrf_token %}

              <div class="mb-3">
                <label class="form-label">Payment ID</label>
                <input type="text" class="form-control" name="payment_id" placeholder="PAY-201" required>
              </div>

              <div class="mb-3">
                <label class="form-label">Invoice</label>
                <select class="form-select" name="invoice_id" required>
                  <option value="">Select invoice</option>
                  {% for inv in invoices %}
                    <option value="{{ inv.id }}">
                      INV-{{ inv.id }} ({{ inv.project.name }}) - ₹{{ inv.amount }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="mb-3">
                <label class="form-label">Amount</label>
                <input type="number" class="form-control" name="amount_paid" step="0.01" required>
              </div>

              <div class="mb-3">
                <label class="form-label">Payment Date</label>
                <input type="date" class="form-control" name="payment_date" required>
              </div>

              <button type="submit" class="btn btn-success w-100">Save Payment</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Pay Now Modal -->
    <div class="modal fade" id="payNowModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-3 position-relative">

          <!-- Processing overlay -->
          <div class="processing" id="processingOverlay">
            <div class="spinner-border" role="status"></div>
            <div class="fw-semibold">Processing payment…</div>
            <div class="text-muted small">This is a dummy flow (no real money).</div>
          </div>

          <div class="modal-header">
            <div>
              <h5 class="modal-title mb-0">Pay Now</h5>
              <small class="text-muted" id="payNowMeta">—</small>
            </div>
            <button class="btn-close" id="payModalCloseBtn" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <form id="payNowForm">
              {% csrf_token %}

              <div class="mb-3">
                <label class="form-label">Payment Method</label>
                <select class="form-select" id="payMethod" name="method" required>
                  <option value="CARD">Credit Card</option>
                  <option value="UPI">UPI</option>
                  <option value="BANK">Bank Transfer</option>
                </select>
              </div>

              <!-- Card -->
              <div id="cardFields">
                <div class="mb-3">
                  <label class="form-label">Card Number</label>
                  <input type="text" class="form-control" name="card_number" placeholder="1234 5678 9012 3456">
                </div>
                <div class="row g-2">
                  <div class="col-6">
                    <label class="form-label">Expiry (MM/YY)</label>
                    <input type="text" class="form-control" name="card_expiry" placeholder="08/28">
                  </div>
                  <div class="col-6">
                    <label class="form-label">CVV</label>
                    <input type="password" class="form-control" name="card_cvv" placeholder="123">
                  </div>
                </div>
              </div>

              <!-- UPI -->
              <div id="upiFields" class="d-none">
                <div class="mb-3">
                  <label class="form-label">UPI ID</label>
                  <input type="text" class="form-control" name="upi_id" placeholder="name@bank">
                </div>
                <div class="mb-3">
                  <label class="form-label">UPI PIN</label>
                  <input type="password" class="form-control" name="upi_pin" placeholder="****">
                </div>
              </div>

              <!-- Bank -->
              <div id="bankFields" class="d-none">
                <div class="mb-3">
                  <label class="form-label">Bank Reference No.</label>
                  <input type="text" class="form-control" name="bank_ref" placeholder="UTR / Ref No">
                </div>
              </div>

              <button type="submit" class="btn btn-primary w-100" id="payBtn">
                Pay (Dummy)
              </button>
            </form>
          </div>

        </div>
      </div>
    </div>

  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return "";
    }

    const payNowModalEl = document.getElementById("payNowModal");
    const payNowForm = document.getElementById("payNowForm");
    const payMethod = document.getElementById("payMethod");
    const cardFields = document.getElementById("cardFields");
    const upiFields = document.getElementById("upiFields");
    const bankFields = document.getElementById("bankFields");
    const payNowMeta = document.getElementById("payNowMeta");
    const payBtn = document.getElementById("payBtn");
    const processingOverlay = document.getElementById("processingOverlay");
    const payModalCloseBtn = document.getElementById("payModalCloseBtn");

    let currentPayUrl = null;

    function toggleMethodFields() {
      const m = payMethod.value;
      cardFields.classList.toggle("d-none", m !== "CARD");
      upiFields.classList.toggle("d-none", m !== "UPI");
      bankFields.classList.toggle("d-none", m !== "BANK");
    }
    toggleMethodFields();
    payMethod.addEventListener("change", toggleMethodFields);

    // Toast helpers (longer display)
    const toastOkEl = document.getElementById("payToast");
    const toastErrEl = document.getElementById("payToastErr");
    const toastOk = new bootstrap.Toast(toastOkEl, { delay: 3000 });
    const toastErr = new bootstrap.Toast(toastErrEl, { delay: 3500 });

    payNowModalEl.addEventListener("show.bs.modal", function (event) {
      const button = event.relatedTarget;
      currentPayUrl = button.getAttribute("data-pay-url");

      const pid = button.getAttribute("data-pay-id");
      const amt = button.getAttribute("data-pay-amount");
      payNowMeta.textContent = `${pid} • ₹${amt}`;

      payNowForm.reset();
      payMethod.value = "CARD";
      toggleMethodFields();

      processingOverlay.classList.remove("show");
      payBtn.disabled = false;
      payModalCloseBtn.disabled = false;
    });

    payNowForm.addEventListener("submit", async function (e) {
      e.preventDefault();
      if (!currentPayUrl) return;

      // Show processing state (slower / realistic)
      processingOverlay.classList.add("show");
      payBtn.disabled = true;
      payModalCloseBtn.disabled = true;

      const formData = new FormData(payNowForm);

      try {
        const resp = await fetch(currentPayUrl, {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": getCookie("csrftoken")
          },
          body: formData
        });

        const data = await resp.json();

        // Artificial delay so it doesn't feel instant
        await new Promise(r => setTimeout(r, 1800));

        processingOverlay.classList.remove("show");

        if (!resp.ok || !data.ok) {
          document.getElementById("payToastErrMsg").textContent = data.message || "Payment failed.";
          toastErr.show();
          payBtn.disabled = false;
          payModalCloseBtn.disabled = false;
          return;
        }

        document.getElementById("payToastMsg").textContent = data.message || "Payment successful.";
        toastOk.show();

        bootstrap.Modal.getInstance(payNowModalEl).hide();

        // Wait a bit before reload so user sees toast
        setTimeout(() => window.location.reload(), 1100);

      } catch (err) {
        processingOverlay.classList.remove("show");
        document.getElementById("payToastErrMsg").textContent = "Network error. Try again.";
        toastErr.show();
        payBtn.disabled = false;
        payModalCloseBtn.disabled = false;
      }
    });

    // ✅ FRONTEND ONLY hide (persistent)
    const HIDDEN_PAYMENTS_KEY = "hiddenPayments";

    function getHiddenPayments() {
      try { return JSON.parse(localStorage.getItem(HIDDEN_PAYMENTS_KEY)) || []; }
      catch { return []; }
    }

    function setHiddenPayments(arr) {
      localStorage.setItem(HIDDEN_PAYMENTS_KEY, JSON.stringify(arr));
    }

    function hidePaymentPersistent(btn) {
      const col = btn.closest(".payment-item");
      if (!col) return;

      const pid = col.getAttribute("data-payment-id");
      if (!pid) return;

      const hidden = new Set(getHiddenPayments());
      hidden.add(pid);
      setHiddenPayments([...hidden]);

      col.style.transition = "opacity .25s ease, transform .25s ease";
      col.style.opacity = "0";
      col.style.transform = "scale(.98)";
      setTimeout(() => col.remove(), 250);
    }

    function resetHiddenPayments() {
      localStorage.removeItem(HIDDEN_PAYMENTS_KEY);
      window.location.reload();
    }

    document.addEventListener("DOMContentLoaded", () => {
      const hidden = new Set(getHiddenPayments());
      document.querySelectorAll(".payment-item").forEach((el) => {
        const pid = el.getAttribute("data-payment-id");
        if (hidden.has(pid)) el.remove();
      });
    });
  </script>

</body>
</html>
