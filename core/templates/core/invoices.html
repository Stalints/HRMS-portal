{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Invoices | HR Portal</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <link rel="stylesheet" href="{% static 'core/css/style.css' %}">

  <style>
    .invoice-card {
      background-color: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(99, 102, 241, 0.1);
      overflow: hidden;
      transition: all 0.4s ease;
      will-change: transform;
    }
    #invoiceTable { transform: translateZ(0); }
    .table-hover tbody tr { backface-visibility: hidden; will-change: transform, opacity; }

    .modal-content { border-radius: 18px; }
    .form-control, .form-select { border-radius: 12px; }

    /* Processing overlay (same feel as payments) */
    .processing{
      position:absolute; inset:0;
      background: rgba(255,255,255,.88);
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:10px;
      border-radius: 18px;
      z-index: 10;
      backdrop-filter: blur(4px);
    }
    .processing.show{ display:flex; }

    .toast-container{ z-index:2000; }
  </style>
</head>

<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg shadow-sm" style="background-color:#1e3a8a;">
    <div class="container">
      <a class="navbar-brand text-white fw-semibold d-flex align-items-center" href="{% url 'core:client_dashboard' %}">
        <i class="bi bi-building me-2"></i> HR Portal
      </a>
      <span class="text-white-50 d-flex align-items-center">
        <i class="bi bi-person-circle me-1"></i> Client
      </span>
    </div>
  </nav>

  <!-- Toasts -->
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="payToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="payToastMsg">Payment successful.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>

    <div id="payToastErr" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="payToastErrMsg">Payment failed.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- Page -->
  <div class="container my-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>Invoices</h2>

      <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" href="{% url 'core:client_dashboard' %}">
          <i class="bi bi-arrow-left me-1"></i> Dashboard
        </a>

        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newInvoiceModal">
          <i class="bi bi-plus-circle me-1"></i> New Invoice
        </button>
      </div>
    </div>

    <!-- Invoice Table -->
    <div class="card shadow-sm">
      <div class="card-body p-0">
        <table class="table table-hover mb-0" id="invoiceTable">
          <thead class="table-dark">
            <tr>
              <th>Invoice ID</th>
              <th>Project</th>
              <th>Issue Date</th>
              <th>Due Date</th>
              <th>Amount</th>
              <th>Status</th>
              <th style="width:260px;">Action</th>
            </tr>
          </thead>

          <tbody>
            {% for inv in invoices %}
            <tr>
              <td>INV-{{ inv.id }}</td>
              <td>{{ inv.project.name }}</td>
              <td>{{ inv.issued_date }}</td>
              <td>{{ inv.due_date|default:"-" }}</td>
              <td>₹{{ inv.amount }}</td>

              <td>
                {% if inv.status == "PAID" %}
                  <span class="badge bg-success">Paid</span>
                {% elif inv.status == "OVERDUE" %}
                  <span class="badge bg-danger">Overdue</span>
                {% else %}
                  <span class="badge bg-warning text-dark">Pending</span>
                {% endif %}
              </td>

              <td class="d-flex gap-2 flex-wrap">

                <!-- View -->
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary"
                  data-bs-toggle="modal"
                  data-bs-target="#invoiceViewModal"
                  data-inv-id="{{ inv.id }}"
                  data-project="{{ inv.project.name }}"
                  data-issue="{{ inv.issued_date }}"
                  data-due="{{ inv.due_date|default:'' }}"
                  data-amount="{{ inv.amount }}"
                  data-status="{{ inv.status }}"
                >
                  <i class="bi bi-eye"></i> View
                </button>

                <!-- Pay -->
                {% if inv.status != "PAID" %}
                <button
                  type="button"
                  class="btn btn-sm btn-success"
                  data-bs-toggle="modal"
                  data-bs-target="#invoicePayModal"
                  data-inv-id="{{ inv.id }}"
                  data-project="{{ inv.project.name }}"
                  data-amount="{{ inv.amount }}"
                >
                  <i class="bi bi-credit-card"></i> Pay
                </button>
                {% else %}
                <button class="btn btn-sm btn-outline-success" disabled>
                  <i class="bi bi-check2-circle"></i> Paid
                </button>
                {% endif %}

              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center py-4">No invoices found.</td>
            </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>
    </div>
  </div>

  <!-- Invoice View Modal -->
  <div class="modal fade" id="invoiceViewModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-2">
        <div class="modal-header border-0">
          <div>
            <h5 class="modal-title mb-0">Invoice Details</h5>
            <small class="text-muted" id="viewMeta">—</small>
          </div>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body pt-0">
          <div class="list-group">
            <div class="list-group-item d-flex justify-content-between">
              <span class="text-muted">Invoice</span>
              <strong id="vInv">—</strong>
            </div>
            <div class="list-group-item d-flex justify-content-between">
              <span class="text-muted">Project</span>
              <strong id="vProject">—</strong>
            </div>
            <div class="list-group-item d-flex justify-content-between">
              <span class="text-muted">Issue Date</span>
              <strong id="vIssue">—</strong>
            </div>
            <div class="list-group-item d-flex justify-content-between">
              <span class="text-muted">Due Date</span>
              <strong id="vDue">—</strong>
            </div>
            <div class="list-group-item d-flex justify-content-between">
              <span class="text-muted">Amount</span>
              <strong>₹<span id="vAmount">0</span></strong>
            </div>
            <div class="list-group-item d-flex justify-content-between">
              <span class="text-muted">Status</span>
              <strong id="vStatus">—</strong>
            </div>
          </div>
        </div>

        <div class="modal-footer border-0">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Invoice Pay Modal -->
  <div class="modal fade" id="invoicePayModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3 position-relative">

        <div class="processing" id="processingOverlay">
          <div class="spinner-border" role="status"></div>
          <div class="fw-semibold">Processing payment…</div>
          <div class="text-muted small">Dummy flow (no real money).</div>
        </div>

        <div class="modal-header border-0">
          <div>
            <h5 class="modal-title mb-0">Pay Invoice</h5>
            <small class="text-muted" id="payInvMeta">—</small>
          </div>
          <button class="btn-close" id="payModalCloseBtn" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body pt-0">
          <form id="invoicePayForm">
            {% csrf_token %}
            <input type="hidden" name="invoice_id" id="payInvoiceId" value="">

            <div class="mb-3">
              <label class="form-label">Payment Method</label>
              <select class="form-select" id="payMethod" name="method" required>
                <option value="CARD">Credit Card</option>
                <option value="UPI">UPI</option>
                <option value="BANK">Bank Transfer</option>
              </select>
            </div>

            <div id="cardFields">
              <div class="mb-3">
                <label class="form-label">Card Number</label>
                <input type="text" class="form-control" name="card_number" placeholder="1234 5678 9012 3456">
              </div>
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label">Expiry (MM/YY)</label>
                  <input type="text" class="form-control" name="card_expiry" placeholder="08/28">
                </div>
                <div class="col-6">
                  <label class="form-label">CVV</label>
                  <input type="password" class="form-control" name="card_cvv" placeholder="123">
                </div>
              </div>
            </div>

            <div id="upiFields" class="d-none">
              <div class="mb-3">
                <label class="form-label">UPI ID</label>
                <input type="text" class="form-control" name="upi_id" placeholder="name@bank">
              </div>
              <div class="mb-3">
                <label class="form-label">UPI PIN</label>
                <input type="password" class="form-control" name="upi_pin" placeholder="****">
              </div>
            </div>

            <div id="bankFields" class="d-none">
              <div class="mb-3">
                <label class="form-label">Bank Reference No.</label>
                <input type="text" class="form-control" name="bank_ref" placeholder="UTR / Ref No">
              </div>
            </div>

            <button type="submit" class="btn btn-success w-100" id="payBtn">Pay (Dummy)</button>
          </form>
        </div>

      </div>
    </div>
  </div>

  <!-- New Invoice Modal -->
  <div class="modal fade" id="newInvoiceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">Create New Invoice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <form method="POST">
            {% csrf_token %}
            <div class="row g-3">

              <div class="col-md-6">
                <label class="form-label">Project</label>
                <select class="form-select" name="project_id" required>
                  <option value="" selected disabled>Select project</option>
                  {% for p in projects %}
                    <option value="{{ p.id }}">{{ p.name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label">Amount</label>
                <input type="number" class="form-control" name="amount" min="0" step="0.01" required>
              </div>

              <div class="col-md-6">
                <label class="form-label">Issue Date</label>
                <input type="date" class="form-control" name="issued_date" required>
              </div>

              <div class="col-md-6">
                <label class="form-label">Due Date</label>
                <input type="date" class="form-control" name="due_date">
              </div>

              <div class="col-md-6">
                <label class="form-label">Status</label>
                <select class="form-select" name="status" required>
                  <option value="PENDING" selected>Pending</option>
                  <option value="PAID">Paid</option>
                  <option value="OVERDUE">Overdue</option>
                </select>
              </div>

            </div>

            <button type="submit" class="btn btn-primary w-100 mt-4">Add Invoice</button>
          </form>
        </div>

      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ✅ best CSRF helper (from hidden input)
    function getCSRFToken() {
      const el = document.querySelector('#invoicePayForm input[name="csrfmiddlewaretoken"]');
      return el ? el.value : "";
    }

    // Toast
    const toastOk = new bootstrap.Toast(document.getElementById("payToast"), { delay: 3000 });
    const toastErr = new bootstrap.Toast(document.getElementById("payToastErr"), { delay: 3500 });

    // VIEW modal fill
    const viewModal = document.getElementById("invoiceViewModal");
    viewModal.addEventListener("show.bs.modal", function (event) {
      const btn = event.relatedTarget;

      const id = btn.getAttribute("data-inv-id");
      const project = btn.getAttribute("data-project");
      const issue = btn.getAttribute("data-issue");
      const due = btn.getAttribute("data-due");
      const amount = btn.getAttribute("data-amount");
      const status = btn.getAttribute("data-status");

      document.getElementById("viewMeta").textContent = `INV-${id} • ${project}`;
      document.getElementById("vInv").textContent = `INV-${id}`;
      document.getElementById("vProject").textContent = project || "—";
      document.getElementById("vIssue").textContent = issue || "—";
      document.getElementById("vDue").textContent = due ? due : "—";
      document.getElementById("vAmount").textContent = amount || "0";
      document.getElementById("vStatus").textContent = status || "—";
    });

    // PAY modal fields
    const payModalEl = document.getElementById("invoicePayModal");
    const payForm = document.getElementById("invoicePayForm");
    const payMethod = document.getElementById("payMethod");
    const cardFields = document.getElementById("cardFields");
    const upiFields = document.getElementById("upiFields");
    const bankFields = document.getElementById("bankFields");
    const payBtn = document.getElementById("payBtn");
    const processingOverlay = document.getElementById("processingOverlay");
    const payModalCloseBtn = document.getElementById("payModalCloseBtn");

    function toggleFields() {
      const m = payMethod.value;
      cardFields.classList.toggle("d-none", m !== "CARD");
      upiFields.classList.toggle("d-none", m !== "UPI");
      bankFields.classList.toggle("d-none", m !== "BANK");
    }
    toggleFields();
    payMethod.addEventListener("change", toggleFields);

    let currentInvoiceId = null;

    payModalEl.addEventListener("show.bs.modal", function (event) {
      const btn = event.relatedTarget;

      const invId = btn.getAttribute("data-inv-id");
      const project = btn.getAttribute("data-project");
      const amount = btn.getAttribute("data-amount");

      currentInvoiceId = invId;
      document.getElementById("payInvoiceId").value = invId;
      document.getElementById("payInvMeta").textContent = `INV-${invId} • ${project} • ₹${amount}`;

      payForm.reset();
      payMethod.value = "CARD";
      toggleFields();

      processingOverlay.classList.remove("show");
      payBtn.disabled = false;
      payModalCloseBtn.disabled = false;
    });

    // ✅ SAFE submit
    payForm.addEventListener("submit", async function (e) {
      e.preventDefault();
      if (!currentInvoiceId) return;

      processingOverlay.classList.add("show");
      payBtn.disabled = true;
      payModalCloseBtn.disabled = true;

      const formData = new FormData(payForm);

      try {
        const resp = await fetch("{% url 'core:invoice_pay_now' %}", {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": getCSRFToken()
          },
          credentials: "same-origin",
          body: formData
        });

        const ct = resp.headers.get("content-type") || "";
        let data = {};
        if (ct.includes("application/json")) {
          data = await resp.json();
        } else {
          const text = await resp.text();
          console.log("Non-JSON response:", text);
          throw new Error("Backend returned non-JSON. Status=" + resp.status);
        }

        await new Promise(r => setTimeout(r, 1200));
        processingOverlay.classList.remove("show");

        if (!resp.ok || !data.ok) {
          document.getElementById("payToastErrMsg").textContent = data.message || "Payment failed.";
          toastErr.show();
          payBtn.disabled = false;
          payModalCloseBtn.disabled = false;
          return;
        }

        document.getElementById("payToastMsg").textContent = data.message || "Payment successful.";
        toastOk.show();

        bootstrap.Modal.getInstance(payModalEl).hide();
        setTimeout(() => window.location.reload(), 900);

      } catch (err) {
        console.log("PAY ERROR:", err);
        processingOverlay.classList.remove("show");
        document.getElementById("payToastErrMsg").textContent =
          "Server error / wrong URL / logged out. Check Django terminal + console.";
        toastErr.show();
        payBtn.disabled = false;
        payModalCloseBtn.disabled = false;
      }
    });
  </script>

</body>
</html>
