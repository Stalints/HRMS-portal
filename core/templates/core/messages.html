{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Messages | HR Portal</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />

  <link rel="stylesheet" href="{% static 'core/css/style.css' %}">

  <style>
    :root{
      --brand:#1e3a8a;
      --bg:#f6f8ff;
      --text:#0f172a;
      --muted:#6b7280;

      --border: rgba(15,23,42,.10);
      --shadow: 0 22px 60px rgba(2,6,23,.10);
      --shadow-soft: 0 12px 30px rgba(2,6,23,.07);

      --radius: 22px;
      --radius-lg: 28px;

      --glass: rgba(255,255,255,.78);
      --glass-strong: rgba(255,255,255,.88);
    }

    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      background:
        radial-gradient(900px 540px at 10% -10%, rgba(30,58,138,.18), transparent 60%),
        radial-gradient(900px 540px at 90% 0%, rgba(14,165,233,.14), transparent 55%),
        radial-gradient(900px 540px at 50% 110%, rgba(34,197,94,.10), transparent 60%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .page{ width:100%; max-width:none; }

    /* Topbar (dashboard style) */
    .topbar{
      background: rgba(255,255,255,.70);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,.45);
    }
    .brand{
      display:flex; align-items:center; gap:.6rem;
      text-decoration:none; color: var(--text);
      padding: .55rem .8rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--glass);
      box-shadow: 0 10px 25px rgba(2,6,23,.05);
      transition: transform .15s ease, box-shadow .15s ease;
      font-weight: 800;
      letter-spacing: -.01em;
    }
    .brand:hover{
      color: var(--text);
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(2,6,23,.07);
    }
    .pill{
      display:flex; align-items:center; gap:.55rem;
      padding:.48rem .85rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--glass);
      color: rgba(15,23,42,.85);
      box-shadow: 0 10px 25px rgba(2,6,23,.05);
      font-size: .92rem;
      font-weight: 700;
    }

    /* Hero */
    .hero{
      margin-top: 18px;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255,255,255,.55);
      background:
        linear-gradient(135deg, rgba(30,58,138,.97), rgba(30,58,138,.75)),
        radial-gradient(700px 260px at 20% 0%, rgba(255,255,255,.18), transparent 60%);
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
    }
    .hero::after{
      content:"";
      position:absolute;
      right:-120px; top:-120px;
      width: 340px; height: 340px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      pointer-events:none;
      z-index:0;
    }
    .hero-inner{
      padding: 22px 22px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 14px;
      color:#fff;
      position:relative;
      z-index:1;
      flex-wrap: wrap;
    }
    .hero h1{
      margin:0;
      font-size: 1.5rem;
      font-weight: 950;
      letter-spacing: -.02em;
    }
    .hero p{
      margin: 6px 0 0;
      color: rgba(255,255,255,.86);
      font-size: 1rem;
      line-height: 1.35;
    }
    .hero-actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
      margin-left:auto;
    }
    .hero-btn{
      display:inline-flex;
      align-items:center;
      gap:.55rem;
      padding: .6rem .95rem;
      border-radius: 999px;
      text-decoration:none;
      font-weight: 900;
      border: 1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.14);
      color:#fff;
      transition: transform .15s ease, background .15s ease, box-shadow .15s ease;
      box-shadow: 0 12px 26px rgba(2,6,23,.10);
    }
    .hero-btn:hover{
      color:#fff;
      background: rgba(255,255,255,.18);
      transform: translateY(-1px);
      box-shadow: 0 16px 34px rgba(2,6,23,.14);
    }
    .hero-btn.secondary{
      background: rgba(255,255,255,.94);
      color: rgba(2,6,23,.90);
      border-color: rgba(255,255,255,.70);
    }
    .hero-btn.secondary:hover{ color: rgba(2,6,23,.95); }

    /* Shell cards */
    .glass-card{
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--glass-strong);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow-soft);
      overflow:hidden;
      height: 72vh;
      min-height: 520px;
    }
    .card-head{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.80));
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .title{
      margin:0;
      font-weight: 950;
      letter-spacing: -.01em;
      color: rgba(2,6,23,.92);
    }
    .sub{
      color: var(--muted);
      font-weight: 800;
      font-size: .92rem;
    }

    /* Search */
    .search{
      position: relative;
      min-width: 220px;
      flex: 1;
      max-width: 420px;
    }
    .search input{
      width:100%;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: .6rem .9rem .6rem 2.35rem;
      background: rgba(255,255,255,.92);
      font-weight: 700;
      outline: none;
    }
    .search i{
      position:absolute;
      left: .85rem;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(2,6,23,.55);
    }

    /* Threads */
    .threads{
      overflow:auto;
      height: calc(72vh - 64px);
      min-height: 456px;
      padding: 10px;
    }
    .thread-item{
      display:flex;
      align-items:center;
      gap: 12px;
      padding: 12px 12px;
      border-radius: 18px;
      cursor:pointer;
      border: 1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.75);
      box-shadow: 0 10px 18px rgba(2,6,23,.04);
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      margin-bottom: 10px;
      user-select:none;
    }
    .thread-item:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 26px rgba(2,6,23,.07);
      border-color: rgba(30,58,138,.18);
    }
    .thread-active{
      border-color: rgba(30,58,138,.26);
      background: rgba(30,58,138,.06);
      box-shadow: 0 18px 32px rgba(30,58,138,.12);
    }
    .thread-avatar{
      width: 44px; height: 44px;
      border-radius: 16px;
      display:grid; place-items:center;
      font-weight: 950;
      color: rgba(2,6,23,.88);
      border: 1px solid rgba(255,255,255,.65);
      box-shadow: 0 12px 24px rgba(2,6,23,.08);
      flex: 0 0 auto;
    }
    .av-finance{ background: linear-gradient(135deg, rgba(59,130,246,.22), rgba(59,130,246,.08)); }
    .av-project{ background: linear-gradient(135deg, rgba(245,158,11,.22), rgba(245,158,11,.08)); }
    .av-hr{ background: linear-gradient(135deg, rgba(34,197,94,.20), rgba(34,197,94,.07)); }

    .thread-title{
      font-weight: 950;
      letter-spacing: -.01em;
      color: rgba(2,6,23,.92);
      margin:0;
      line-height: 1.1;
    }
    .thread-sub{
      margin: 4px 0 0;
      color: rgba(100,116,139,.95);
      font-weight: 700;
      font-size: .92rem;
    }
    .thread-meta{
      margin-left:auto;
      text-align:right;
      color: rgba(100,116,139,.95);
      font-weight: 800;
      font-size: .85rem;
      white-space: nowrap;
    }

    /* Chat */
    .chat{
      height: calc(72vh - 64px);
      min-height: 456px;
      display:flex;
      flex-direction: column;
    }
    .messages{
      flex: 1;
      overflow-y:auto;
      padding: 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      background:
        radial-gradient(700px 260px at 20% 0%, rgba(30,58,138,.06), transparent 60%),
        rgba(255,255,255,.58);
    }
    .bubble{
      max-width: 78%;
      padding: 12px 14px;
      border-radius: 18px;
      border: 1px solid rgba(15,23,42,.08);
      box-shadow: 0 10px 18px rgba(2,6,23,.04);
      background: rgba(255,255,255,.92);
    }
    .bubble .meta{
      font-size: .82rem;
      font-weight: 800;
      color: rgba(100,116,139,.95);
      margin-bottom: 4px;
    }
    .sent{
      align-self:flex-end;
      background: rgba(30,58,138,.10);
      border-color: rgba(30,58,138,.14);
    }
    .received{
      align-self:flex-start;
      background: rgba(34,197,94,.10);
      border-color: rgba(34,197,94,.16);
    }

    .composer{
      border-top: 1px solid var(--border);
      padding: 12px;
      background: rgba(248,250,252,.75);
      display:flex;
      gap: 10px;
      align-items:flex-end;
    }
    .composer textarea{
      flex: 1;
      resize: none;
      border-radius: 18px;
      border: 1px solid rgba(15,23,42,.10);
      padding: 10px 12px;
      font-weight: 700;
      min-height: 44px;
      max-height: 130px;
      background: rgba(255,255,255,.92);
    }
    .composer textarea:focus{
      outline: none;
      box-shadow: 0 0 0 .25rem rgba(30,58,138,.14);
      border-color: rgba(30,58,138,.30);
    }
    .btn-send{
      border-radius: 999px;
      padding: .6rem .95rem;
      font-weight: 950;
      border: 1px solid rgba(30,58,138,.20);
      background: rgba(30,58,138,1);
      color:#fff;
      box-shadow: 0 12px 22px rgba(30,58,138,.18);
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
      white-space: nowrap;
    }
    .btn-send:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(30,58,138,.22);
      background: rgba(30,58,138,.92);
      color:#fff;
    }

    @media (max-width: 992px){
      .glass-card{ height:auto; min-height: unset; }
      .threads, .chat{ height: auto; min-height: unset; }
      .messages{ max-height: 420px; }
    }
    @media (max-width: 768px){
      .hero-actions{ width:100%; justify-content:flex-start; }
      .search{ max-width: none; }
      .thread-meta{ display:none; }
    }
  </style>
</head>

<body>

  <!-- Topbar -->
  <nav class="navbar topbar py-3">
    <div class="container-fluid page px-4 px-lg-5 d-flex justify-content-between align-items-center">
      <a class="brand" href="{% url 'core:client_dashboard' %}">
        <i class="bi bi-building"></i>
        <span>HR Portal</span>
      </a>
      <div class="pill">
        <i class="bi bi-person-circle"></i>
        <span>Client</span>
      </div>
    </div>
  </nav>

  <div class="container-fluid page px-4 px-lg-5">

    <!-- Hero -->
    <div class="hero">
      <div class="hero-inner">
        <div>
          <h1>Messages</h1>
          <p>Chat with Finance, HR, and your Project team.</p>
        </div>
        <div class="hero-actions">
          <a class="hero-btn secondary" href="{% url 'core:client_dashboard' %}">
            <i class="bi bi-arrow-left"></i> Dashboard
          </a>
          <a class="hero-btn" href="{% url 'core:support' %}">
            <i class="bi bi-headset"></i> Raise Ticket
          </a>
        </div>
      </div>
    </div>

    <div class="row g-3 g-lg-4 mt-3 pb-4">

      <!-- Threads -->
      <div class="col-12 col-lg-4">
        <div class="glass-card">
          <div class="card-head">
            <div>
              <div class="title">Conversations</div>
              <div class="sub">Select a thread to view messages</div>
            </div>

            <div class="search">
              <i class="bi bi-search"></i>
              <input id="threadSearch" type="text" placeholder="Search chats..." />
            </div>
          </div>

          <div class="threads" id="threadList">

            <!-- Finance -->
            <div class="thread-item thread-active"
              data-title="Finance Team • Invoice clarification"
              data-messages='[
                {"type":"received","sender":"Finance Team","time":"10:15 AM","text":"Please check the updated invoice attached."},
                {"type":"sent","sender":"You","time":"10:30 AM","text":"Thanks, I will review and confirm shortly."},
                {"type":"received","sender":"Finance Team","time":"10:35 AM","text":"Let us know if you need any changes."}
              ]'>
              <div class="thread-avatar av-finance">F</div>
              <div>
                <p class="thread-title mb-0">Finance Team</p>
                <p class="thread-sub">Invoice clarification</p>
              </div>
              <div class="thread-meta">Today</div>
            </div>

            <!-- Project -->
            <div class="thread-item"
              data-title="Project Manager • Sprint update"
              data-messages='[
                {"type":"received","sender":"Project Manager","time":"9:00 AM","text":"Sprint is on track."},
                {"type":"sent","sender":"You","time":"9:10 AM","text":"Great, keep me posted."}
              ]'>
              <div class="thread-avatar av-project">P</div>
              <div>
                <p class="thread-title mb-0">Project Manager</p>
                <p class="thread-sub">Sprint update</p>
              </div>
              <div class="thread-meta">Today</div>
            </div>

            <!-- HR -->
            <div class="thread-item"
              data-title="HR Team • Document submission"
              data-messages='[
                {"type":"received","sender":"HR Team","time":"11:00 AM","text":"Please submit your pending documents."}
              ]'>
              <div class="thread-avatar av-hr">H</div>
              <div>
                <p class="thread-title mb-0">HR Team</p>
                <p class="thread-sub">Document submission</p>
              </div>
              <div class="thread-meta">Today</div>
            </div>

          </div>
        </div>
      </div>

      <!-- Chat -->
      <div class="col-12 col-lg-8">
        <div class="glass-card">
          <div class="card-head">
            <div>
              <div class="title" id="chatTitle">Finance Team • Invoice clarification</div>
              <div class="sub">Your messages are visible only to your account</div>
            </div>

            <button type="button" class="btn btn-soft btn-sm" onclick="scrollToBottom()">
              <i class="bi bi-arrow-down-circle me-1"></i> Latest
            </button>
          </div>

          <div class="chat">
            <div class="messages" id="chatMessages"></div>

            <div class="composer">
              <textarea id="msgBox" placeholder="Type your message..."></textarea>
              <button type="button" class="btn-send" id="sendBtn">
                <i class="bi bi-send-fill me-1"></i> Send
              </button>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <script>
    const threads = document.querySelectorAll(".thread-item");
    const chatTitle = document.getElementById("chatTitle");
    const chatMessages = document.getElementById("chatMessages");
    const msgBox = document.getElementById("msgBox");
    const sendBtn = document.getElementById("sendBtn");
    const threadSearch = document.getElementById("threadSearch");

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function renderBubble(msg){
      const div = document.createElement("div");
      div.className = `bubble ${msg.type === "sent" ? "sent" : "received"}`;
      div.innerHTML = `
        <div class="meta">${escapeHtml(msg.sender)} • ${escapeHtml(msg.time)}</div>
        <div class="text">${escapeHtml(msg.text)}</div>
      `;
      return div;
    }

    function scrollToBottom(){
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function loadMessages(thread) {
      chatTitle.textContent = thread.dataset.title;
      const messages = JSON.parse(thread.dataset.messages || "[]");
      chatMessages.innerHTML = "";
      messages.forEach(m => chatMessages.appendChild(renderBubble(m)));
      scrollToBottom();
    }

    threads.forEach(thread => {
      thread.addEventListener("click", () => {
        threads.forEach(t => t.classList.remove("thread-active"));
        thread.classList.add("thread-active");
        loadMessages(thread);
      });
    });

    // Demo send (frontend only)
    function sendLocalMessage(){
      const text = (msgBox.value || "").trim();
      if(!text) return;

      const active = document.querySelector(".thread-item.thread-active");
      if(!active) return;

      const now = new Date();
      const hh = String(now.getHours()).padStart(2,"0");
      const mm = String(now.getMinutes()).padStart(2,"0");

      const msg = { type:"sent", sender:"You", time:`${hh}:${mm}`, text };
      const list = JSON.parse(active.dataset.messages || "[]");
      list.push(msg);
      active.dataset.messages = JSON.stringify(list);

      chatMessages.appendChild(renderBubble(msg));
      msgBox.value = "";
      scrollToBottom();
    }

    sendBtn.addEventListener("click", sendLocalMessage);
    msgBox.addEventListener("keydown", (e) => {
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        sendLocalMessage();
      }
    });

    // Search threads (frontend only)
    threadSearch.addEventListener("input", () => {
      const q = (threadSearch.value || "").toLowerCase();
      document.querySelectorAll("#threadList .thread-item").forEach(item => {
        const title = (item.dataset.title || "").toLowerCase();
        item.style.display = title.includes(q) ? "flex" : "none";
      });
    });

    // Load default active conversation
    loadMessages(document.querySelector(".thread-active"));
  </script>

</body>
</html>