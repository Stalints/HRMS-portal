{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Messages | HR Portal</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'core/css/style.css' %}">

  <style>
    :root {
      /* dashboard/projects theme */
      --bg: #f6f7fb;
      --card: rgba(255, 255, 255, .78);
      --card-strong: rgba(255, 255, 255, .92);
      --text: #0b1220;
      --muted: #667085;
      --border: rgba(15, 23, 42, .10);

      --primary: hsl(243 75% 59%);
      --p2: hsl(262 60% 58%);
      --p3: hsl(330 65% 55%);
      --teal: hsl(172 56% 42%);
      --blue: hsl(200 70% 50%);
      --green: hsl(152 55% 42%);
      --amber: hsl(35 80% 55%);

      --shadow: 0 18px 50px rgba(2, 6, 23, .08);
      --shadow-soft: 0 10px 26px rgba(2, 6, 23, .06);

      --r: 18px;
      --r2: 22px;
    }

    body {
      min-height: 100vh;
      background:
        radial-gradient(1000px 600px at 10% -10%, rgba(99, 102, 241, .12), transparent 55%),
        radial-gradient(900px 520px at 90% 0%, rgba(236, 72, 153, .10), transparent 55%),
        linear-gradient(180deg, #f7f8ff, #f5f6fb);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* FULL WIDTH FEEL */
    .wrap {
      max-width: 1400px;
      margin: 0 auto;
      padding-left: 12px;
      padding-right: 12px;
    }

    @media (min-width: 576px) {
      .wrap {
        padding-left: 18px;
        padding-right: 18px;
      }
    }

    /* NAV (dashboard style) */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255, 255, 255, .70);
      backdrop-filter: blur(18px);
      border-bottom: 1px solid rgba(15, 23, 42, .08);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: var(--text);
      font-weight: 900;
      letter-spacing: -.02em;
    }

    .brand-badge {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      display: grid;
      place-items: center;
      background: linear-gradient(135deg, var(--primary), var(--p2));
      color: #fff;
      box-shadow: 0 14px 28px rgba(99, 102, 241, .20);
    }

    .pill {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(255, 255, 255, .80);
      border: 1px solid rgba(15, 23, 42, .10);
      box-shadow: 0 10px 18px rgba(2, 6, 23, .06);
      font-weight: 800;
      color: var(--text);
      user-select: none;
      white-space: nowrap;
    }

    .pill .avatar {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      background: linear-gradient(135deg, var(--primary), var(--p3));
      color: #fff;
    }

    /* BASE CARD */
    .card-base {
      background: var(--card-strong);
      border: 1px solid rgba(15, 23, 42, .10);
      border-radius: var(--r2);
      box-shadow: var(--shadow-soft);
    }

    /* HERO (projects style) */
    .hero {
      position: relative;
    }

    .hero-accent {
      height: 6px;
      background: linear-gradient(90deg, var(--primary), var(--p2), var(--p3));
    }

    .hero::after {
      content: "";
      position: absolute;
      top: -90px;
      right: -90px;
      width: 260px;
      height: 260px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(99, 102, 241, .12), transparent 65%);
      pointer-events: none;
    }

    .hero h1 {
      margin: 0;
      font-size: clamp(22px, 2vw, 30px);
      font-weight: 950;
      letter-spacing: -.03em;
      line-height: 1.15;
    }

    .hero p {
      margin: 10px 0 0;
      color: var(--muted);
      max-width: 620px;
      font-weight: 700;
      line-height: 1.35;
    }

    /* BUTTONS */
    .btn-grad {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      border-radius: 14px;
      text-decoration: none;
      color: #fff;
      font-weight: 900;
      background: linear-gradient(90deg, var(--primary), var(--p2));
      box-shadow: 0 16px 30px rgba(99, 102, 241, .22);
      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
      border: 0;
      white-space: nowrap;
    }

    .btn-grad:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 22px 40px rgba(99, 102, 241, .28);
      filter: brightness(1.03);
      color: #fff;
    }

    .btn-soft {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 42px;
      height: 42px;
      border-radius: 14px;
      background: rgba(15, 23, 42, .04);
      border: 1px solid rgba(15, 23, 42, .10);
      color: rgba(15, 23, 42, .65);
      text-decoration: none;
      transition: transform .16s ease, border-color .16s ease, background .16s ease, color .16s ease;
      white-space: nowrap;
    }

    .btn-soft:hover {
      transform: translateY(-1px);
      border-color: rgba(99, 102, 241, .25);
      background: rgba(99, 102, 241, .06);
      color: rgba(15, 23, 42, .90);
    }

    /* PANELS */
    .panel {
      overflow: hidden;
      height: 72vh;
      min-height: 520px;
      display: flex;
      flex-direction: column;
    }

    .panel-head {
      padding: 14px 16px;
      border-bottom: 1px solid rgba(15, 23, 42, .08);
      background: linear-gradient(180deg, rgba(255, 255, 255, .98), rgba(255, 255, 255, .86));
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .title {
      margin: 0;
      font-weight: 950;
      letter-spacing: -.01em;
      color: rgba(2, 6, 23, .92);
      line-height: 1.2;
    }

    .sub {
      color: var(--muted);
      font-weight: 800;
      font-size: .92rem;
    }

    /* SEARCH */
    .search {
      position: relative;
      min-width: 240px;
      flex: 1;
      max-width: 420px;
    }

    .search i {
      position: absolute;
      left: .85rem;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(2, 6, 23, .55);
    }

    .search input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, .12);
      padding: .62rem .95rem .62rem 2.35rem;
      background: rgba(15, 23, 42, .03);
      font-weight: 800;
      outline: none;
    }

    .search input:focus {
      box-shadow: 0 0 0 .25rem rgba(99, 102, 241, .12);
      border-color: rgba(99, 102, 241, .30);
      background: rgba(255, 255, 255, .95);
    }

    /* THREAD LIST */
    .threads {
      flex: 1;
      overflow: auto;
      padding: 12px;
    }

    .thread-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 12px;
      border-radius: 18px;
      cursor: pointer;
      border: 1px solid rgba(15, 23, 42, .10);
      background: rgba(255, 255, 255, .86);
      box-shadow: var(--shadow-soft);
      transition: transform .14s ease, box-shadow .14s ease, border-color .14s ease, background .14s ease;
      margin-bottom: 12px;
      user-select: none;
    }

    .thread-item:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
      border-color: rgba(99, 102, 241, .22);
    }

    .thread-active {
      border-color: rgba(99, 102, 241, .35);
      background: rgba(99, 102, 241, .06);
      box-shadow: 0 18px 40px rgba(99, 102, 241, .12);
    }

    .thread-avatar {
      width: 44px;
      height: 44px;
      border-radius: 16px;
      display: grid;
      place-items: center;
      font-weight: 950;
      color: rgba(2, 6, 23, .92);
      border: 1px solid rgba(255, 255, 255, .70);
      box-shadow: 0 12px 24px rgba(2, 6, 23, .08);
      flex: 0 0 auto;
    }

    .av-finance {
      background: linear-gradient(135deg, rgba(59, 130, 246, .22), rgba(59, 130, 246, .08));
    }

    .av-project {
      background: linear-gradient(135deg, rgba(245, 158, 11, .22), rgba(245, 158, 11, .08));
    }

    .av-hr {
      background: linear-gradient(135deg, rgba(34, 197, 94, .20), rgba(34, 197, 94, .07));
    }

    .thread-title {
      font-weight: 950;
      letter-spacing: -.01em;
      color: rgba(2, 6, 23, .92);
      margin: 0;
      line-height: 1.1;
    }

    .thread-sub {
      margin: 4px 0 0;
      color: rgba(100, 116, 139, .95);
      font-weight: 750;
      font-size: .92rem;
    }

    .thread-meta {
      margin-left: auto;
      text-align: right;
      color: rgba(100, 116, 139, .95);
      font-weight: 850;
      font-size: .85rem;
      white-space: nowrap;
    }

    /* CHAT */
    .chat {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    .messages {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background:
        radial-gradient(700px 260px at 20% 0%, rgba(99, 102, 241, .10), transparent 60%),
        rgba(255, 255, 255, .60);
    }

    .bubble {
      max-width: 78%;
      padding: 12px 14px;
      border-radius: 18px;
      border: 1px solid rgba(15, 23, 42, .10);
      box-shadow: var(--shadow-soft);
      background: rgba(255, 255, 255, .92);
    }

    .bubble .meta {
      font-size: .82rem;
      font-weight: 850;
      color: rgba(100, 116, 139, .95);
      margin-bottom: 4px;
    }

    .sent {
      align-self: flex-end;
      background: rgba(99, 102, 241, .10);
      border-color: rgba(99, 102, 241, .18);
    }

    .received {
      align-self: flex-start;
      background: rgba(34, 197, 94, .10);
      border-color: rgba(34, 197, 94, .18);
    }

    .composer {
      border-top: 1px solid rgba(15, 23, 42, .10);
      padding: 12px;
      background: rgba(248, 250, 252, .78);
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    .composer textarea {
      flex: 1;
      resize: none;
      border-radius: 18px;
      border: 1px solid rgba(15, 23, 42, .12);
      padding: 10px 12px;
      font-weight: 800;
      min-height: 44px;
      max-height: 140px;
      background: rgba(15, 23, 42, .03);
      line-height: 1.25;
      outline: none;
    }

    .composer textarea:focus {
      box-shadow: 0 0 0 .25rem rgba(99, 102, 241, .12);
      border-color: rgba(99, 102, 241, .30);
      background: rgba(255, 255, 255, .95);
    }

    .btn-send {
      border-radius: 14px;
      padding: .62rem .95rem;
      font-weight: 950;
      border: 0;
      color: #fff;
      background: linear-gradient(90deg, var(--primary), var(--p2));
      box-shadow: 0 14px 26px rgba(99, 102, 241, .22);
      transition: transform .14s ease, box-shadow .14s ease, filter .14s ease;
      white-space: nowrap;
    }

    .btn-send:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 34px rgba(99, 102, 241, .28);
      filter: brightness(1.03);
      color: #fff;
    }

    /* RESPONSIVE */
    @media (max-width: 992px) {
      .panel {
        height: auto;
        min-height: unset;
      }

      .messages {
        max-height: 420px;
      }
    }

    @media (max-width: 768px) {
      .thread-meta {
        display: none;
      }

      .search {
        max-width: none;
      }
    }
  </style>
</head>

<body>

  <!-- NAV (dashboard style) -->
  <nav class="topbar">
    <div class="wrap">
      <div class="d-flex align-items-center justify-content-between" style="height:64px;">
        <a class="brand" href="{% url 'core:client_dashboard' %}">
          <span class="brand-badge"><i class="bi bi-building"></i></span>
          <span>HR Portal</span>
        </a>

        <div class="pill">
          <span class="avatar"><i class="bi bi-person-fill" style="font-size:.85rem;"></i></span>
          Client
        </div>
      </div>
    </div>
  </nav>

  <main class="wrap py-4 py-sm-5">

    <!-- HERO (projects style) -->
    <section class="card-base hero">
      <div class="hero-accent"></div>

      <div
        class="p-4 p-sm-5 d-flex flex-column flex-sm-row align-items-start align-items-sm-center justify-content-between gap-3 gap-sm-4">
        <div class="d-flex align-items-center gap-3">
          <a class="btn-soft" href="{% url 'core:client_dashboard' %}" title="Back">
            <i class="bi bi-arrow-left"></i>
          </a>

          <div>
            <h1>Messages <span style="font-size:1.05em;">ðŸ’¬</span></h1>
            <p>Chat with HR and your Project team.</p>
          </div>
        </div>

        <div class="d-flex gap-2 gap-sm-3 flex-wrap">
          {% if available_users %}
          <div class="dropdown">
            <button class="btn btn-primary btn-grad dropdown-toggle" type="button" id="startChatMenu"
              data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-chat-dots-fill"></i> Start New Chat
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="startChatMenu">
              {% for u in available_users %}
              <li><a class="dropdown-item" href="{% url 'core:chat_start' u.id %}">
                  {% if u.profile.role == 'HR' %}
                  {{ u.get_full_name|default:u.username }} (HR Admin)
                  {% else %}
                  {{ u.get_full_name|default:u.username }} ({{ u.profile.role }})
                  {% endif %}
                </a></li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- CONTENT -->
    <section class="mt-4">
      <div class="row g-3 g-lg-4">

        <!-- Threads -->
        <div class="col-12 col-lg-4">
          <div class="card-base panel">
            <div class="panel-head">
              <div>
                <div class="title">Conversations</div>
                <div class="sub">Select a thread to view messages</div>
              </div>

              <div class="search">
                <i class="bi bi-search"></i>
                <input id="threadSearch" type="text" placeholder="Search chats..." />
              </div>
            </div>

            <div class="threads" id="threadList">

              {% for conv in conversations %}
              <a href="{% url 'core:chat_room' conv.id %}" class="text-decoration-none">
                <div
                  class="thread-item {% if active_conversation and active_conversation.id == conv.id %}thread-active{% endif %}">
                  <div
                    class="thread-avatar {% if forloop.counter|divisibleby:3 %}av-finance{% elif forloop.counter|divisibleby:2 %}av-project{% else %}av-hr{% endif %}">
                    {{ conv.get_last_message.sender.username|first|upper|default:"?" }}
                  </div>
                  <div>
                    <p class="thread-title mb-0">
                      {% for p in conv.participants.all %}
                      {% if p != request.user %}
                      {{ p.get_full_name|default:p.username }}
                      {% endif %}
                      {% endfor %}
                    </p>
                    <p class="thread-sub text-truncate" style="max-width: 200px;">
                      {% if conv.get_last_message %}
                      {{ conv.get_last_message.content }}
                      {% else %}
                      No messages yet
                      {% endif %}
                    </p>
                  </div>
                  <div class="thread-meta">
                    {% if conv.get_last_message %}
                    {{ conv.get_last_message.timestamp|date:"M d, H:i" }}
                    {% endif %}
                  </div>
                </div>
              </a>
              {% empty %}
              <div class="text-center p-4">
                <p class="text-muted">No active conversations.</p>
              </div>
              {% endfor %}

            </div>
          </div>
        </div>

        <!-- Chat -->
        <div class="col-12 col-lg-8">
          <div class="card-base panel">
            {% if active_conversation %}
            <div class="panel-head">
              <div>
                <div class="title" id="chatTitle">
                  {% for p in active_conversation.participants.all %}
                  {% if p != request.user %}
                  {{ p.get_full_name|default:p.username }}
                  {% endif %}
                  {% endfor %}
                </div>
                <div class="sub" id="chat-status-text">Connected securely</div>
              </div>

              <div class="d-flex align-items-center gap-2">
                <a href="{% url 'core:chat_delete' active_conversation.id %}" class="btn-soft text-danger"
                  onclick="return confirm('Are you sure you want to delete this conversation?');"
                  title="Delete Conversation">
                  <i class="bi bi-trash"></i>
                </a>
                <button type="button" class="btn-soft" style="width:auto; padding:10px 14px;"
                  onclick="scrollToBottom()">
                  <i class="bi bi-arrow-down-circle"></i> Latest
                </button>
              </div>
            </div>

            <div class="chat">
              <div class="messages" id="chat-log">
                {% for msg in messages %}
                <div class="bubble {% if msg.sender == request.user %}sent{% else %}received{% endif %}">
                  <div class="meta">{{ msg.sender.get_full_name|default:msg.sender.username }} â€¢ {{
                    msg.timestamp|date:"M d, h:i A" }}</div>
                  <div class="text">{{ msg.content }}</div>
                </div>
                {% endfor %}
              </div>

              <div class="composer">
                <textarea id="chat-message-input" placeholder="Type your message..." autocomplete="off"></textarea>
                <button type="button" class="btn-send" id="chat-message-submit">
                  <i class="bi bi-send-fill me-1"></i> Send
                </button>
              </div>
            </div>

            <!-- JS WebSocket Setup -->
            {{ active_conversation.id|json_script:"room-name" }}
            <script>
              document.addEventListener('DOMContentLoaded', function () {
                const roomId = JSON.parse(document.getElementById('room-name').textContent);
                const wsProtocol = window.location.protocol === "https:" ? "wss://" : "ws://";
                const chatSocket = new WebSocket(wsProtocol + window.location.host + '/ws/chat/' + roomId + '/');

                const chatLog = document.getElementById('chat-log');

                function scrollToBottom() {
                  chatLog.scrollTop = chatLog.scrollHeight;
                }
                scrollToBottom();

                window.scrollToBottom = scrollToBottom;

                chatSocket.onmessage = function (e) {
                  const data = JSON.parse(e.data);

                  if (data.type === 'new_message') {
                    const currentUserId = Number("{{ request.user.id }}");
                    const isSender = (Number(data.sender_id) === currentUserId);

                    const msgDiv = document.createElement('div');
                    msgDiv.className = `bubble ${isSender ? 'sent' : 'received'}`;

                    msgDiv.innerHTML = `
                                <div class="meta">${isSender ? 'You' : data.sender_name} â€¢ ${data.timestamp}</div>
                                <div class="text">${data.message}</div>
                            `;

                    chatLog.appendChild(msgDiv);
                    scrollToBottom();
                  }
                };

                chatSocket.onclose = function (e) {
                  console.error('Chat socket closed unexpectedly');
                  const statusEl = document.getElementById('chat-status-text');
                  if (statusEl) {
                    statusEl.innerText = "Disconnected";
                    statusEl.classList.add("text-danger");
                  }
                };

                const messageInputDom = document.getElementById('chat-message-input');
                messageInputDom.focus();

                messageInputDom.onkeyup = function (e) {
                  if (e.keyCode === 13 && !e.shiftKey) {  // enter, return
                    document.getElementById('chat-message-submit').click();
                  }
                };

                document.getElementById('chat-message-submit').onclick = function (e) {
                  const message = messageInputDom.value.trim();
                  if (message !== "") {
                    chatSocket.send(JSON.stringify({
                      'message': message
                    }));
                    messageInputDom.value = '';
                  }
                };
              });
            </script>
            {% else %}
            <div class="h-100 d-flex flex-column align-items-center justify-content-center text-muted p-5 text-center"
              style="min-height: 400px;">
              <h1 class="opacity-50" style="font-size: 4rem;"><i class="bi bi-chat-quote"></i></h1>
              <h5 class="fw-bold mt-3" style="color: var(--text);">Your Messages</h5>
              <p class="mb-0">Select a conversation from the left to start messaging</p>
              <p>or click "Start New Chat" above to begin a new thread.</p>
            </div>
            {% endif %}
          </div>
        </div>

      </div>
    </section>

  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Init Global Online Tracker JS -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const wsProtocol = window.location.protocol === "https:" ? "wss://" : "ws://";
      const statusSocket = new WebSocket(wsProtocol + window.location.host + '/ws/online-status/');
      statusSocket.onclose = function (e) { console.log("Status connection closed."); };
    });
  </script>


    <!-- Notification System JS -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const wsProtocol = window.location.protocol === "https:" ? "wss://" : "ws://";
            const notifySocket = new WebSocket(wsProtocol + window.location.host + '/ws/notifications/');

            function updateBadge(count) {
                const badges = document.querySelectorAll('.global-chat-badge');
                badges.forEach(b => {
                    if(count > 0) {
                        b.textContent = count;
                        b.style.display = 'inline-block';
                    } else {
                        b.style.display = 'none';
                    }
                });
            }

            function showToast(sender, preview) {
                const toast = document.createElement('div');
                toast.style.position = 'fixed';
                toast.style.bottom = '20px';
                toast.style.right = '20px';
                toast.style.background = '#4f46e5';
                toast.style.color = 'white';
                toast.style.padding = '12px 20px';
                toast.style.borderRadius = '12px';
                toast.style.boxShadow = '0 10px 25px rgba(0,0,0,0.2)';
                toast.style.zIndex = '9999';
                toast.style.transition = 'opacity 0.3s';
                toast.style.fontFamily = 'system-ui, sans-serif';
                toast.innerHTML = `<div style="font-weight:bold; margin-bottom:4px;">New Message from ${sender} <span style="font-size:16px;">ðŸ’¬</span></div><div style="font-size:0.9em; opacity:0.9;">${preview}</div>`;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }, 5000);
            }

            notifySocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                if (data.type === 'unread_count_init') {
                    updateBadge(data.unread_count);
                } else if (data.type === 'chat_notification') {
                    updateBadge(data.unread_count);
                    if (!window.location.pathname.includes('/chat/') && !window.location.pathname.includes('/messages/')) {
                        showToast(data.sender_name, data.message_preview);
                    }
                }
            };
        });
    </script>
</body>


</html>